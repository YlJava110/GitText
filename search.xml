<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[Toast源码解读]]></title>
      <url>/2019/10/11/Toast%E8%A7%A3%E8%AF%BB/</url>
      <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Toast(吐司)，这个控件的用词相当准确,它所表现出来的特征正是吐司似的弹出效果，使用非常简单便捷。<br>而且Toast开发时比较常用的一个类了，用它给用户弹提示信息和界面反馈，有时候也用它来作为辅助调试的手段。但是用得多了，有时候自然会遇到各种各样的问题，比如重复点击问题，弹框位置，显示时间等，这时候我们就要对运行机制以及源码进行了解。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>1.Toast不是View，它用于帮助创建并展示包含一条小消息的View；</p>
<p>2.它的设计理念是尽量不惹眼，但又能展示想让用户看到的信息；</p>
<p>3.被展示时，浮在应用界面之上；</p>
<p>4.永远不会获取到焦点；</p>
<p>5.大小取决于消息的长度；</p>
<p>6.超时后会自动消失；</p>
<p>7.可以自定义显示在屏幕上的位置（默认左右居中显示在靠近屏幕底部的位置；</p>
<p>8.可以使用自定义布局，也只有在自定义布局的时候才需要直接调用Toast的构造方法，其它时候都是使用 makeText方法来创建Toast；</p>
<p>9.Toast弹出后当前Activity会保持可见性和可交互性；</p>
<p>10.使用cancel方法可以立即将已显示的Toast关闭让未显示的Toast不再显示；</p>
<p>11.Toast 也算是一个「通知」，如果弹出状态消息后期望得到用户响应，应该使用 Notification。</p>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><h4 id="new-Toast"><a href="#new-Toast" class="headerlink" title="new Toast"></a>new Toast</h4><blockquote>
<p>Toast.class</p>
<p>这里面初始化了TN,TN是什么？一会下面会讲道</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Constructs an empty Toast object.  If looper is null, Looper.myLooper() is used.</span><br><span class="line"> * @hide</span><br><span class="line"> */</span><br><span class="line">public Toast(@NonNull Context context, @Nullable Looper looper) &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mTN = new TN(context.getPackageName(), looper);</span><br><span class="line">    mTN.mY = context.getResources().getDimensionPixelSize(</span><br><span class="line">            com.android.internal.R.dimen.toast_y_offset);</span><br><span class="line">    mTN.mGravity = context.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_toastDefaultGravity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Toast-makeText"><a href="#Toast-makeText" class="headerlink" title="Toast.makeText"></a>Toast.makeText</h4><blockquote>
<p>Toast.class</p>
<p>这里面蕴含了很多的信息,XML布局,text显示文案，显示时长等等</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Toast.class</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Make a standard toast to display using the specified looper.</span><br><span class="line"> * If looper is null, Looper.myLooper() is used.</span><br><span class="line"> * @hide</span><br><span class="line"> */</span><br><span class="line">public static Toast makeText(@NonNull Context context, @Nullable Looper looper,</span><br><span class="line">        @NonNull CharSequence text, @Duration int duration) &#123;</span><br><span class="line">    Toast result = new Toast(context, looper);</span><br><span class="line"></span><br><span class="line">    LayoutInflater inflate = (LayoutInflater)</span><br><span class="line">            context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">    View v = inflate.inflate(com.android.internal.R.layout.transient_notification, null);</span><br><span class="line">    TextView tv = (TextView)v.findViewById(com.android.internal.R.id.message);</span><br><span class="line">    tv.setText(text);</span><br><span class="line"></span><br><span class="line">    result.mNextView = v;</span><br><span class="line">    result.mDuration = duration;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="显示"><a href="#显示" class="headerlink" title="显示"></a>显示</h3><blockquote>
<p>Toast.class</p>
<p>这里是show一个Toast,显示的时候把tn，和包名相关信息传递给service，将我们需要显示的toast放到这个服务的队列中进行显示。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Show the view for the specified duration.</span><br><span class="line"> */</span><br><span class="line">public void show() &#123;</span><br><span class="line">    if (mNextView == null) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;setView must have been called&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    INotificationManager service = getService();</span><br><span class="line">    String pkg = mContext.getOpPackageName();</span><br><span class="line">    TN tn = mTN;</span><br><span class="line">    tn.mNextView = mNextView;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        service.enqueueToast(pkg, tn, mDuration);</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        // Empty</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NotificationManagerService.class</p>
<p>Toast入系统队列的方法:在Toast的TN对象中，会调用service.enqueueToast(String pkg,ItransientNotification callback,int duaraion)来将创建出来的Toast放入NotificationManagerService的ToastRecord队列中。<br>NotificationManagerService是一个运行在SystemServer进程中的一个守护进程，Android大部分的IPC通信都是通过Binder机制，这个守护进程像一个主管一样，所有的下面的人都必须让它进行调度，然后由它来进行显示或者是隐藏。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void enqueueToast(String pkg, ITransientNotification callback, int duration)</span><br><span class="line">&#123;</span><br><span class="line">    .........................................</span><br><span class="line"></span><br><span class="line">    synchronized (mToastQueue) &#123;</span><br><span class="line">        int callingPid = Binder.getCallingPid();</span><br><span class="line">        long callingId = Binder.clearCallingIdentity();</span><br><span class="line">        try &#123;</span><br><span class="line">            ToastRecord record;</span><br><span class="line">            int index;</span><br><span class="line">            // All packages aside from the android package can enqueue one toast at a time</span><br><span class="line">            //查看这个toast是否在当前队列中，有的话就返回索引</span><br><span class="line">            if (!isSystemToast) &#123;</span><br><span class="line">                index = indexOfToastPackageLocked(pkg);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                index = indexOfToastLocked(pkg, callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // If the package already has a toast, we update its toast</span><br><span class="line">            // in the queue, we don&apos;t move it to the end of the queue.</span><br><span class="line">            //如果这个index大于等于0，说明这个toast已经在这个队列中了，只需要更新显示时间就可以了</span><br><span class="line">            //当然这里callback是一个对象，pkg是一个String，所以比较的时候是对象的比较</span><br><span class="line">            if (index &gt;= 0) &#123;</span><br><span class="line">                record = mToastQueue.get(index);</span><br><span class="line">                record.update(duration);</span><br><span class="line">                try &#123;</span><br><span class="line">                    record.callback.hide();</span><br><span class="line">                &#125; catch (RemoteException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                record.update(callback);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">            		//将这个toast封装成ToastRecord对象，放到队列中</span><br><span class="line">                Binder token = new Binder();</span><br><span class="line">                mWindowManagerInternal.addWindowToken(token, TYPE_TOAST, DEFAULT_DISPLAY);</span><br><span class="line">                record = new ToastRecord(callingPid, pkg, callback, duration, token);</span><br><span class="line">                mToastQueue.add(record);</span><br><span class="line">                index = mToastQueue.size() - 1;</span><br><span class="line">            &#125;</span><br><span class="line">            keepProcessAliveIfNeededLocked(callingPid);</span><br><span class="line">            // If it&apos;s at index 0, it&apos;s the current toast.  It doesn&apos;t matter if it&apos;s</span><br><span class="line">            // new or just been updated.  Call back and tell it to show itself.</span><br><span class="line">            // If the callback fails, this will remove it from the list, so don&apos;t</span><br><span class="line">            // assume that it&apos;s valid after this.</span><br><span class="line">            //如果返回的索引是0，说明当前的这个存在的toast就在对头，直接显示</span><br><span class="line">            if (index == 0) &#123;</span><br><span class="line">                showNextToastLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(callingId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void showNextToastLocked() &#123;</span><br><span class="line">    ToastRecord record = mToastQueue.get(0);</span><br><span class="line">    ....................................  </span><br><span class="line">    record.callback.show(record.token);</span><br><span class="line">    scheduleTimeoutLocked(record);</span><br><span class="line">    return;</span><br><span class="line">    ...................................    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void scheduleTimeoutLocked(ToastRecord r)</span><br><span class="line">&#123;</span><br><span class="line">    mHandler.removeCallbacksAndMessages(r);</span><br><span class="line">    Message m = Message.obtain(mHandler, MESSAGE_TIMEOUT, r);</span><br><span class="line">    long delay = r.duration == Toast.LENGTH_LONG ? LONG_DELAY : SHORT_DELAY;</span><br><span class="line">    mHandler.sendMessageDelayed(m, delay);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void handleTimeout(ToastRecord record)</span><br><span class="line">&#123;</span><br><span class="line">        int index = indexOfToastLocked(record.pkg, record.callback);</span><br><span class="line">        if (index &gt;= 0) &#123;</span><br><span class="line">            cancelToastLocked(index);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="取消"><a href="#取消" class="headerlink" title="取消"></a>取消</h3><blockquote>
<p>NotificationManagerService.class</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void cancelToastLocked(int index) &#123;</span><br><span class="line">    ToastRecord record = mToastQueue.get(index);</span><br><span class="line">    try &#123;</span><br><span class="line">        record.callback.hide();</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ToastRecord lastToast = mToastQueue.remove(index);</span><br><span class="line">    mWindowManagerInternal.removeWindowToken(lastToast.token, true, DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    keepProcessAliveIfNeededLocked(record.pid);</span><br><span class="line">    if (mToastQueue.size() &gt; 0) &#123;</span><br><span class="line">        // Show the next one. If the callback fails, this will remove</span><br><span class="line">        // it from the list, so don&apos;t assume that the list hasn&apos;t changed</span><br><span class="line">        // after this point.</span><br><span class="line">        showNextToastLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TN"><a href="#TN" class="headerlink" title="TN"></a>TN</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">private static class TN extends ITransientNotification.Stub &#123;</span><br><span class="line">    private final WindowManager.LayoutParams mParams = new WindowManager.LayoutParams();</span><br><span class="line">.................................................................</span><br><span class="line"></span><br><span class="line">    TN(String packageName, @Nullable Looper looper) &#123;</span><br><span class="line">        // XXX This should be changed to use a Dialog, with a Theme.Toast</span><br><span class="line">        // defined that sets up the layout params appropriately.</span><br><span class="line">        final WindowManager.LayoutParams params = mParams;</span><br><span class="line">        params.height = WindowManager.LayoutParams.WRAP_CONTENT;</span><br><span class="line">        params.width = WindowManager.LayoutParams.WRAP_CONTENT;</span><br><span class="line">        params.format = PixelFormat.TRANSLUCENT;</span><br><span class="line">        params.windowAnimations = com.android.internal.R.style.Animation_Toast;</span><br><span class="line">        params.type = WindowManager.LayoutParams.TYPE_TOAST;</span><br><span class="line">        params.setTitle(&quot;Toast&quot;);</span><br><span class="line">        params.flags = WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON</span><br><span class="line">                | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE</span><br><span class="line">                | WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE;</span><br><span class="line"></span><br><span class="line">        mPackageName = packageName;</span><br><span class="line"></span><br><span class="line">        if (looper == null) &#123;</span><br><span class="line">            // Use Looper.myLooper() if looper is not specified.</span><br><span class="line">            looper = Looper.myLooper();</span><br><span class="line">            if (looper == null) &#123;</span><br><span class="line">                throw new RuntimeException(</span><br><span class="line">                        &quot;Can&apos;t toast on a thread that has not called Looper.prepare()&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mHandler = new Handler(looper, null) &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void handleMessage(Message msg) &#123;</span><br><span class="line">                switch (msg.what) &#123;</span><br><span class="line">                    case SHOW: &#123;</span><br><span class="line">                        IBinder token = (IBinder) msg.obj;</span><br><span class="line">                        handleShow(token);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    case HIDE: &#123;</span><br><span class="line">                        handleHide();</span><br><span class="line">                        // Don&apos;t do this in handleHide() because it is also invoked by</span><br><span class="line">                        // handleShow()</span><br><span class="line">                        mNextView = null;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    case CANCEL: &#123;</span><br><span class="line">                        handleHide();</span><br><span class="line">                        // Don&apos;t do this in handleHide() because it is also invoked by</span><br><span class="line">                        // handleShow()</span><br><span class="line">                        mNextView = null;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            getService().cancelToast(mPackageName, TN.this);</span><br><span class="line">                        &#125; catch (RemoteException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * schedule handleShow into the right thread</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void show(IBinder windowToken) &#123;</span><br><span class="line">        if (localLOGV) Log.v(TAG, &quot;SHOW: &quot; + this);</span><br><span class="line">        mHandler.obtainMessage(SHOW, windowToken).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * schedule handleHide into the right thread</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void hide() &#123;</span><br><span class="line">        if (localLOGV) Log.v(TAG, &quot;HIDE: &quot; + this);</span><br><span class="line">        mHandler.obtainMessage(HIDE).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void cancel() &#123;</span><br><span class="line">        if (localLOGV) Log.v(TAG, &quot;CANCEL: &quot; + this);</span><br><span class="line">        mHandler.obtainMessage(CANCEL).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void handleShow(IBinder windowToken) &#123;</span><br><span class="line">        .................................................</span><br><span class="line">            if (mView != mNextView) &#123;</span><br><span class="line">            // remove the old view if necessary</span><br><span class="line">            handleHide();</span><br><span class="line">            mView = mNextView;</span><br><span class="line">            Context context = mView.getContext().getApplicationContext();</span><br><span class="line">            String packageName = mView.getContext().getOpPackageName();</span><br><span class="line">            if (context == null) &#123;</span><br><span class="line">                context = mView.getContext();</span><br><span class="line">            &#125;</span><br><span class="line">            mWM = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">            // We can resolve the Gravity here by using the Locale for getting</span><br><span class="line">            // the layout direction</span><br><span class="line">            final Configuration config = mView.getContext().getResources().getConfiguration();</span><br><span class="line">            final int gravity = Gravity.getAbsoluteGravity(mGravity, config.getLayoutDirection());</span><br><span class="line">            mParams.gravity = gravity;</span><br><span class="line">            if ((gravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) == Gravity.FILL_HORIZONTAL) &#123;</span><br><span class="line">                mParams.horizontalWeight = 1.0f;</span><br><span class="line">            &#125;</span><br><span class="line">            if ((gravity &amp; Gravity.VERTICAL_GRAVITY_MASK) == Gravity.FILL_VERTICAL) &#123;</span><br><span class="line">                mParams.verticalWeight = 1.0f;</span><br><span class="line">            &#125;</span><br><span class="line">            mParams.x = mX;</span><br><span class="line">            mParams.y = mY;</span><br><span class="line">            mParams.verticalMargin = mVerticalMargin;</span><br><span class="line">            mParams.horizontalMargin = mHorizontalMargin;</span><br><span class="line">            mParams.packageName = packageName;</span><br><span class="line">            mParams.hideTimeoutMilliseconds = mDuration ==</span><br><span class="line">                Toast.LENGTH_LONG ? LONG_DURATION_TIMEOUT : SHORT_DURATION_TIMEOUT;</span><br><span class="line">            mParams.token = windowToken;</span><br><span class="line">            if (mView.getParent() != null) &#123;</span><br><span class="line">                if (localLOGV) Log.v(TAG, &quot;REMOVE! &quot; + mView + &quot; in &quot; + this);</span><br><span class="line">                mWM.removeView(mView);</span><br><span class="line">            &#125;</span><br><span class="line">            if (localLOGV) Log.v(TAG, &quot;ADD! &quot; + mView + &quot; in &quot; + this);</span><br><span class="line">            // Since the notification manager service cancels the token right</span><br><span class="line">            // after it notifies us to cancel the toast there is an inherent</span><br><span class="line">            // race and we may attempt to add a window after the token has been</span><br><span class="line">            // invalidated. Let us hedge against that.</span><br><span class="line">            try &#123;</span><br><span class="line">                mWM.addView(mView, mParams);</span><br><span class="line">                trySendAccessibilityEvent();</span><br><span class="line">            &#125; catch (WindowManager.BadTokenException e) &#123;</span><br><span class="line">                /* ignore */</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void trySendAccessibilityEvent() &#123;</span><br><span class="line">        AccessibilityManager accessibilityManager =</span><br><span class="line">                AccessibilityManager.getInstance(mView.getContext());</span><br><span class="line">        if (!accessibilityManager.isEnabled()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // treat toasts as notifications since they are used to</span><br><span class="line">        // announce a transient piece of information to the user</span><br><span class="line">        AccessibilityEvent event = AccessibilityEvent.obtain(</span><br><span class="line">                AccessibilityEvent.TYPE_NOTIFICATION_STATE_CHANGED);</span><br><span class="line">        event.setClassName(getClass().getName());</span><br><span class="line">        event.setPackageName(mView.getContext().getPackageName());</span><br><span class="line">        mView.dispatchPopulateAccessibilityEvent(event);</span><br><span class="line">        accessibilityManager.sendAccessibilityEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void handleHide() &#123;</span><br><span class="line">        if (localLOGV) Log.v(TAG, &quot;HANDLE HIDE: &quot; + this + &quot; mView=&quot; + mView);</span><br><span class="line">        if (mView != null) &#123;</span><br><span class="line">            // note: checking parent() just to make sure the view has</span><br><span class="line">            // been added...  i have seen cases where we get here when</span><br><span class="line">            // the view isn&apos;t yet added, so let&apos;s try not to crash.</span><br><span class="line">            if (mView.getParent() != null) &#123;</span><br><span class="line">                if (localLOGV) Log.v(TAG, &quot;REMOVE! &quot; + mView + &quot; in &quot; + this);</span><br><span class="line">                mWM.removeViewImmediate(mView);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mView = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="显示时长"><a href="#显示时长" class="headerlink" title="显示时长"></a>显示时长</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static final int LONG_DELAY = PhoneWindowManager.TOAST_WINDOW_TIMEOUT;</span><br><span class="line">public static final int TOAST_WINDOW_TIMEOUT = 3500; // 3.5 seconds</span><br><span class="line">static final int SHORT_DELAY = 2000; // 2 seconds</span><br></pre></td></tr></table></figure>

<h3 id="超时时长"><a href="#超时时长" class="headerlink" title="超时时长"></a>超时时长</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static final long SHORT_DURATION_TIMEOUT = 4000;</span><br><span class="line">static final long LONG_DURATION_TIMEOUT = 7000;</span><br></pre></td></tr></table></figure>

<h2 id="问题解答"><a href="#问题解答" class="headerlink" title="问题解答"></a>问题解答</h2><h3 id="能否在非-UI-线程调用"><a href="#能否在非-UI-线程调用" class="headerlink" title="能否在非 UI 线程调用"></a>能否在非 UI 线程调用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">new Thread(new Runnable() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        Toast.makeText(getContext(), &quot;Call toast on non-UI thread&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<p>异常提示：Can’t create handler inside thread that has not called Looper.prepare()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">new Thread(new Runnable() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        Toast.makeText(getContext(), &quot;Call toast on non-UI thread&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">        Looper.loop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<h3 id="Toast数量"><a href="#Toast数量" class="headerlink" title="Toast数量"></a>Toast数量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static final int MAX_PACKAGE_NOTIFICATIONS = 50;</span><br></pre></td></tr></table></figure>

<h3 id="Service中能否显示Toast"><a href="#Service中能否显示Toast" class="headerlink" title="Service中能否显示Toast"></a>Service中能否显示Toast</h3><p>可以。但是网上说IntentService不可以,因为IntentService运行在独立的线程中，所以Toast不正常需要通过Handler运行于主线程之上，但是我打印IntentService也是main线程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Handler handler = new Handler(Looper.getMainLooper());  </span><br><span class="line">handler.post(new Runnable() &#123;  </span><br><span class="line">	public void run() &#123;  </span><br><span class="line">		dialog.show();  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><h3 id="源码差异"><a href="#源码差异" class="headerlink" title="源码差异"></a>源码差异</h3><blockquote>
<p>8 以下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (index &gt;= 0) &#123;</span><br><span class="line">    record = mToastQueue.get(index);</span><br><span class="line">    record.update(duration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>9</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (index &gt;= 0) &#123;</span><br><span class="line">    record = mToastQueue.get(index);</span><br><span class="line">    record.update(duration);</span><br><span class="line">    try &#123;</span><br><span class="line">        record.callback.hide();</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    record.update(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果9，快速点击，当toast弹框，再次点击立刻消失，然后到事件后，清除队列后才能再次显示。而8以下，则是toast弹框到时间消失后，再次点击才能显示。两者toast每次显示的时间不同。</p>
<h3 id="系统问题"><a href="#系统问题" class="headerlink" title="系统问题"></a>系统问题</h3><p>某些手机系统源码做了修改，比如红米5p，如果一直点击，在toast消失后，则不会在弹提示。停下一段时间后，log会输入异常提示。初步认定是快速点击时的toast机制做了修改。这个困扰了我好长时间，最后根据日志，和其他的手机才发现这个问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2019-11-08 17:41:33.311 1632-1632/? W/WindowManager: Attempted to remove non-existing token: android.os.Binder@bc43f4e</span><br><span class="line">2019-11-08 17:41:33.315 1632-2685/? W/WindowManager: Failed looking up window</span><br><span class="line">    java.lang.IllegalArgumentException: Requested window android.os.BinderProxy@22ce86f does not exist</span><br><span class="line">        at com.android.server.wm.WindowManagerService.windowForClientLocked(WindowManagerService.java:9651)</span><br><span class="line">        at com.android.server.wm.WindowManagerService.windowForClientLocked(WindowManagerService.java:9642)</span><br><span class="line">        at com.android.server.wm.WindowManagerService.removeWindow(WindowManagerService.java:2420)</span><br><span class="line">        at com.android.server.wm.Session.remove(Session.java:202)</span><br><span class="line">        at android.view.IWindowSession$Stub.onTransact(IWindowSession.java:242)</span><br><span class="line">        at com.android.server.wm.Session.onTransact(Session.java:145)</span><br><span class="line">        at android.os.Binder.execTransact(Binder.java:567)</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整个调研过程比较长，期间主要卡在了国内手机厂商的系统修改上，今后在遇到同样问题，还是要做测试，尽量早发现问题，今早提出解决和方案。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/mzlogin/article/details/78580687" target="_blank" rel="noopener">Android 源码分析 —— 从 Toast 出发</a></p>
<p><a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/services/core/java/com/android/server/notification/NotificationManagerService.java" target="_blank" rel="noopener">NotificationManagerService</a></p>
<p><a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/view/WindowManager.java" target="_blank" rel="noopener">WindowManager</a></p>
<p><a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java" target="_blank" rel="noopener">Toast</a></p>
<p><a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/services/core/java/com/android/server/policy/PhoneWindowManager.java" target="_blank" rel="noopener">PhoneWindowManager</a></p>
<p><a href="https://blog.csdn.net/androidguy/article/details/90750688" target="_blank" rel="noopener">关于Binder中clearCallingIdentity()与restoreCallingIdentity()的作用及如何实现权限认证</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Toast </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[TextView图文混排居中、图片被截断、自动换行问题]]></title>
      <url>/2019/09/26/TextView%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E5%B1%85%E4%B8%AD%E3%80%81%E5%9B%BE%E7%89%87%E8%A2%AB%E6%88%AA%E6%96%AD%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在Android中做图文混排，一般都是选择用TextView+ImageSpan来实现，但是在ImageSpan中，对齐方式只有ImageSpan.ALIGN_BASELINE,ImageSpan.ALIGN_BOTTOM两种对齐方式，不能相对于文本居中，如果我们图片小于文字，或者大于文字，都会导致排版问题出现。</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/09/26/TextView图文混排居中、图片被截断问题/nocenter.png" alt="nocenter" title class>
                <p>nocenter</p>
            </figure>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/09/26/TextView图文混排居中、图片被截断问题/blocked.png" alt="blocked" title class>
                <p>blocked</p>
            </figure>
<h2 id="居中"><a href="#居中" class="headerlink" title="居中"></a>居中</h2><p>下面是抄自wangkunlin同学都一个居中实现代码，封装的很好，就拿过来直接用了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">package com.wkl.imagespan;</span><br><span class="line"></span><br><span class="line">import android.graphics.Canvas;</span><br><span class="line">import android.graphics.Paint;</span><br><span class="line">import android.graphics.Rect;</span><br><span class="line">import android.graphics.drawable.Drawable;</span><br><span class="line">import android.support.annotation.IntDef;</span><br><span class="line">import android.text.style.ImageSpan;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.ref.WeakReference;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by wangkunlin</span><br><span class="line"> * On 2017-03-15</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class AlignImageSpan extends ImageSpan &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 顶部对齐</span><br><span class="line">     */</span><br><span class="line">    public static final int ALIGN_TOP = 3;</span><br><span class="line">    /**</span><br><span class="line">     * 垂直居中</span><br><span class="line">     */</span><br><span class="line">    public static final int ALIGN_CENTER = 4;</span><br><span class="line"></span><br><span class="line">    @IntDef(&#123;ALIGN_BOTTOM, ALIGN_BASELINE, ALIGN_TOP, ALIGN_CENTER&#125;)</span><br><span class="line">    @Retention(RetentionPolicy.SOURCE)</span><br><span class="line">    public @interface Alignment &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AlignImageSpan(Drawable d) &#123;</span><br><span class="line">        this(d, ALIGN_CENTER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AlignImageSpan(Drawable d, @Alignment int verticalAlignment) &#123;</span><br><span class="line">        super(d, verticalAlignment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getSize(Paint paint, CharSequence text, int start, int end, Paint.FontMetricsInt fm) &#123;</span><br><span class="line">        Drawable d = getCachedDrawable();</span><br><span class="line">        Rect rect = d.getBounds();</span><br><span class="line">        if (fm != null) &#123;</span><br><span class="line">            Paint.FontMetrics fmPaint = paint.getFontMetrics();</span><br><span class="line">            // 顶部 leading</span><br><span class="line">            float topLeading = fmPaint.top - fmPaint.ascent;</span><br><span class="line">            // 底部 leading</span><br><span class="line">            float bottomLeading = fmPaint.bottom - fmPaint.descent;</span><br><span class="line">            // drawable 的高度</span><br><span class="line">            int drHeight = rect.height();</span><br><span class="line"></span><br><span class="line">            switch (mVerticalAlignment) &#123;</span><br><span class="line">                case ALIGN_CENTER: &#123; // drawable 的中间与 行中间对齐</span><br><span class="line">                    // 当前行 的高度</span><br><span class="line">                    float fontHeight = fmPaint.descent - fmPaint.ascent;</span><br><span class="line">                    // 整行的 y方向上的中间 y 坐标</span><br><span class="line">                    float center = fmPaint.descent - fontHeight / 2;</span><br><span class="line"></span><br><span class="line">                    // 算出 ascent 和 descent</span><br><span class="line">                    float ascent = center - drHeight / 2;</span><br><span class="line">                    float descent = center + drHeight / 2;</span><br><span class="line"></span><br><span class="line">                    fm.ascent = (int) ascent;</span><br><span class="line">                    fm.top = (int) (ascent + topLeading);</span><br><span class="line">                    fm.descent = (int) descent;</span><br><span class="line">                    fm.bottom = (int) (descent + bottomLeading);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                case ALIGN_BASELINE: &#123; // drawable 的底部与 baseline 对齐</span><br><span class="line">                    // 所以 ascent 的值就是 负的 drawable 的高度</span><br><span class="line">                    float ascent = -drHeight;</span><br><span class="line">                    fm.ascent = -drHeight;</span><br><span class="line">                    fm.top = (int) (ascent + topLeading);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                case ALIGN_TOP: &#123; // drawable 的顶部与 行的顶部 对齐</span><br><span class="line">                    // 算出 descent</span><br><span class="line">                    float descent = drHeight + fmPaint.ascent;</span><br><span class="line">                    fm.descent = (int) descent;</span><br><span class="line">                    fm.bottom = (int) (descent + bottomLeading);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                case ALIGN_BOTTOM: // drawable 的底部与 行的底部 对齐</span><br><span class="line">                default: &#123;</span><br><span class="line">                    // 算出 ascent</span><br><span class="line">                    float ascent = fmPaint.descent - drHeight;</span><br><span class="line">                    fm.ascent = (int) ascent;</span><br><span class="line">                    fm.top = (int) (ascent + topLeading);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return rect.right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 这里的 x, y, top 以及 bottom 都是基于整个 TextView 的坐标系的坐标</span><br><span class="line">     *</span><br><span class="line">     * @param x      drawable 绘制的起始 x 坐标</span><br><span class="line">     * @param top    当前行最高处，在 TextView 中的 y 坐标</span><br><span class="line">     * @param y      当前行的 BaseLine 在 TextView 中的 y 坐标</span><br><span class="line">     * @param bottom 当前行最低处，在 TextView 中的 y 坐标</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void draw(Canvas canvas, CharSequence text, int start, int end, float x, int top, int y, int bottom, Paint paint) &#123;</span><br><span class="line">        Drawable drawable = getDrawable();</span><br><span class="line">        Rect rect = drawable.getBounds();</span><br><span class="line">        float transY;</span><br><span class="line">        switch (mVerticalAlignment) &#123;</span><br><span class="line">            case ALIGN_BASELINE:</span><br><span class="line">                transY = y - rect.height();</span><br><span class="line">                break;</span><br><span class="line">            case ALIGN_CENTER:</span><br><span class="line">                transY = ((bottom - top) - rect.height()) / 2 + top;</span><br><span class="line">                break;</span><br><span class="line">            case ALIGN_TOP:</span><br><span class="line">                transY = top;</span><br><span class="line">                break;</span><br><span class="line">            case ALIGN_BOTTOM:</span><br><span class="line">            default:</span><br><span class="line">                transY = bottom - rect.height();</span><br><span class="line">        &#125;</span><br><span class="line">        canvas.save();</span><br><span class="line">        // 这里如果不移动画布，drawable 就会在 Textview 的左上角出现</span><br><span class="line">        canvas.translate(x, transY);</span><br><span class="line">        drawable.draw(canvas);</span><br><span class="line">        canvas.restore();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Drawable getCachedDrawable() &#123;</span><br><span class="line">        WeakReference&lt;Drawable&gt; wr = mDrawableRef;</span><br><span class="line">        Drawable d = null;</span><br><span class="line"></span><br><span class="line">        if (wr != null)</span><br><span class="line">            d = wr.get();</span><br><span class="line"></span><br><span class="line">        if (d == null) &#123;</span><br><span class="line">            d = getDrawable();</span><br><span class="line">            mDrawableRef = new WeakReference&lt;&gt;(d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private WeakReference&lt;Drawable&gt; mDrawableRef;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="截断处理"><a href="#截断处理" class="headerlink" title="截断处理"></a>截断处理</h2><p>图片被截断，在概述里我们说明了原因，那怎么解决呢？这里我们使用了TextUtils.ellipsize，它相当于 TextView的xml中ellipsize，是在获取TextView已setMaxLines后，显示出来的带有…结尾的内容。</p>
<p>所以我们就可以通过计算，获取到最终显示的文本，然后直接显示了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//获取图片大小</span><br><span class="line">int wh = mContext.getResources().getDimensionPixelOffset(R.dimen.28);</span><br><span class="line">textView.post(() -&gt; &#123;</span><br><span class="line">    int width = textView.getWidth(); //获取textview宽度</span><br><span class="line">    int padding = textView.getPaddingLeft()+textView.getPaddingRight();//获取textview 内边距</span><br><span class="line">    int lineWidth = width - padding-wh*2;//获取实际展示的但航内容宽度</span><br><span class="line">    //通过TextUtils.ellipsize获取截断后的实际文本</span><br><span class="line">    String ellipsizeStr = TextUtils.ellipsize(signature, textView.getPaint(), lineWidth*2, TextUtils.TruncateAt.END).toString();</span><br><span class="line">    textView.setText(getSignatureText(&quot;.  &quot;+ellipsizeStr+&quot;  .&quot;,wh));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private SpannableString getSignatureText(String selfDesc,int wh)&#123;</span><br><span class="line">        Drawable drawableLeft = mContext.getResources().getDrawable(R.drawable.mark_left);</span><br><span class="line">        drawableLeft.setBounds(0, 0, wh, wh);</span><br><span class="line">        AlignImageSpan imgSpanLeft = new AlignImageSpan(drawableLeft, AlignImageSpan.ALIGN_CENTER);</span><br><span class="line"></span><br><span class="line">        Drawable drawableRight = mContext.getResources().getDrawable(R.drawable.mark_right);</span><br><span class="line">        drawableRight.setBounds(0, 0, wh, wh);</span><br><span class="line">        AlignImageSpan imgSpanRight = new AlignImageSpan(drawableRight, AlignImageSpan.ALIGN_CENTER);</span><br><span class="line"></span><br><span class="line">        SpannableString spannableString = new SpannableString(selfDesc);</span><br><span class="line">        spannableString.setSpan(imgSpanLeft, 0, 1, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">        spannableString.setSpan(imgSpanRight, selfDesc.length()-1, selfDesc.length(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">        return spannableString;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong></p>
<p><strong>“.  “+ellipsizeStr+”  .”，我们在这里加入图片的地方加了点和空格，点是为了占位，空格是为了设置与文字之间的间距。为啥要用点占位，不加占位的话，首个文字会被开始的图片给截取点，导致少展示了一个开始的文字。（但是直接用系统ImageSpan，不用TextUtils.ellipsize的时候就不会，感兴趣的朋友可以验证下原因）。</strong></p>
<h2 id="自动换行"><a href="#自动换行" class="headerlink" title="自动换行"></a>自动换行</h2><p>通过计算每个字符的宽度，来自动添加\n换行,且xml中不需要设置ellipsize。暂支持只两行，其他情况原理相同。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">textView.post(() -&gt; &#123;</span><br><span class="line">        String endText = getAutoSplitText(textView,signature,2);</span><br><span class="line">        textView.setText(getSignatureText(endText,wh));</span><br><span class="line">    &#125;);</span><br><span class="line">        </span><br><span class="line">private String getAutoSplitText(TextView textView, String signature, int maxLineCount) &#123;</span><br><span class="line">	int imgSize = mContext.getResources().getDimensionPixelOffset(R.dimen.px28);</span><br><span class="line">	String rawText = signature.replaceAll(&quot;\r&quot;, &quot;&quot;);</span><br><span class="line">	final Paint tvPaint = textView.getPaint();</span><br><span class="line">	float space = tvPaint.measureText(&quot;  &quot;);</span><br><span class="line">	float dot = tvPaint.measureText(&quot;...&quot;);</span><br><span class="line">	float tvWidth = textView.getWidth() - textView.getPaddingLeft() - textView.getPaddingRight(); //控件可用宽度</span><br><span class="line">	//如果整行宽度超过控件可用宽度，则按字符测量，在超过可用宽度的前一个字符处手动换行</span><br><span class="line">	StringBuilder startText = new StringBuilder();</span><br><span class="line">	float lineWidth = imgSize + space;</span><br><span class="line">	int lineCount = 0;</span><br><span class="line">	for (int count = 0; count &lt; rawText.length(); ++count) &#123;</span><br><span class="line">	    char ch = rawText.charAt(count);</span><br><span class="line">	    lineWidth += tvPaint.measureText(String.valueOf(ch));</span><br><span class="line">	    if (lineWidth &lt;= tvWidth) &#123;</span><br><span class="line">	        startText.append(ch);</span><br><span class="line">	    &#125; else &#123;</span><br><span class="line">	        startText.append(&quot;\n&quot;);</span><br><span class="line">	        lineCount++;</span><br><span class="line">	        if (lineCount == maxLineCount) &#123;</span><br><span class="line">	            break;</span><br><span class="line">	        &#125;</span><br><span class="line">	        tvWidth = tvWidth - imgSize - space - dot - tvPaint.measureText(String.valueOf(ch));</span><br><span class="line">	        lineWidth = 0;</span><br><span class="line">	        --count;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//把结尾多余的\n去掉</span><br><span class="line">	if (startText.toString().endsWith(&quot;\n&quot;)) &#123;</span><br><span class="line">	    startText.deleteCharAt(startText.length() - 1);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	StringBuilder endText = new StringBuilder();</span><br><span class="line">	if(lineCount &lt; 2)&#123;</span><br><span class="line">	    endText.append(&quot;img  &quot;).append(startText).append(&quot;  img&quot;);</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">	    endText.append(&quot;img  &quot;).append(startText).append(&quot;...  img&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	return endText.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><figure class="image-box">
                <img src="http://nunu03.github.io/2019/09/26/TextView图文混排居中、图片被截断问题/nodot.png" alt="nodot" title class>
                <p>nodot</p>
            </figure>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/09/26/TextView图文混排居中、图片被截断问题/dot.png" alt="dot" title class>
                <p>dot</p>
            </figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://ddrv.cn/a/232387" target="_blank" rel="noopener">TextView 图文混排，解决图片被截断</a></p>
<p><a href="https://blog.csdn.net/jdsjlzx/article/details/90033791" target="_blank" rel="noopener">TextView图文混排图片被截断的问题以及Android省略号只有一个点的问题</a></p>
<p><a href="https://blog.csdn.net/jiangtea/article/details/54098123" target="_blank" rel="noopener">SpannableString的用法详解</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android 7.0之后抓包证书无效的解决方案]]></title>
      <url>/2019/09/20/Android-7-0%E4%B9%8B%E5%90%8E%E6%8A%93%E5%8C%85%E8%AF%81%E4%B9%A6%E6%97%A0%E6%95%88%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
      <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>使用抓包软件（以 Charles 为例）抓取APP的 https 请求时，Android和Charles都正确安装了证书却出现抓包失败，报错：</p>
<p>Failure    Client SSL handshake failed: An unknown issue occurred processing the certificate (certificate_unknown)</p>
<p><img src="http://nunu03.github.io/2019/09/20/Android-7-0%E4%B9%8B%E5%90%8E%E6%8A%93%E5%8C%85%E8%AF%81%E4%B9%A6%E6%97%A0%E6%95%88%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/certunknow.png" alt="certunknow"></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="导出-pem"><a href="#导出-pem" class="headerlink" title="导出.pem"></a>导出.pem</h3><h3 id="获取文件名"><a href="#获取文件名" class="headerlink" title="获取文件名"></a>获取文件名</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -subject_hash -in  /Users/chenyulong01/Desktop/Untitled.pem </span><br><span class="line">07cc5b45</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIFbDCCBFSgAwIBAgIGAV84nCXLMA0GCSqGSIb3DQEBCwUAMIG6MUswSQYDVQQD</span><br><span class="line">DEJDaGFybGVzIFByb3h5IENBICgyMCDljYHmnIggMjAxNywgY2hlbnl1bG9uZzAx</span><br><span class="line">ZGVNYWNCb29rLVByby5sb2NhbCkxJTAjBgNVBAsMHGh0dHBzOi8vY2hhcmxlc3By</span><br><span class="line">b3h5LmNvbS9zc2wxETAPBgNVBAoMCFhLNzIgTHRkMREwDwYDVQQHDAhBdWNrbGFu</span><br><span class="line">ZDERMA8GA1UECAwIQXVja2xhbmQxCzAJBgNVBAYTAk5aMB4XDTAwMDEwMTAwMDAw</span><br><span class="line">MFoXDTQ2MTIxNzA3MDc1OFowgboxSzBJBgNVBAMMQkNoYXJsZXMgUHJveHkgQ0Eg</span><br><span class="line">KDIwIOWNgeaciCAyMDE3LCBjaGVueXVsb25nMDFkZU1hY0Jvb2stUHJvLmxvY2Fs</span><br><span class="line">KTElMCMGA1UECwwcaHR0cHM6Ly9jaGFybGVzcHJveHkuY29tL3NzbDERMA8GA1UE</span><br><span class="line">CgwIWEs3MiBMdGQxETAPBgNVBAcMCEF1Y2tsYW5kMREwDwYDVQQIDAhBdWNrbGFu</span><br><span class="line">ZDELMAkGA1UEBhMCTlowggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCU</span><br><span class="line">i7FUgkLSIxIYcQWXNf4OkncxNZl1SWXExV8whjC3W+IWA3C3gJgYVY57j4uj+B1q</span><br><span class="line">EGbqIYw4dok3ayB+Yrrcm0WVirb4IJVwUc/EfNnkqAluc/US01Mti6+PuUnya8ze</span><br><span class="line">JZN8ZzJReIgiI7LlYlrPjD0hl4cTckpsdcGLqlfkjuXyeUU3b/qNyKsquAq42o8M</span><br><span class="line">ngB7zbObsie/EpEsI3beqa7MForKeuq5Cc900IdMfTqeIATY7GTdtyXPXPzSionF</span><br><span class="line">TcYMk3QQqLZz+hqF6v8sKB4NeZNFpjSzJF2l7xjUMApMeDppaBN8kTSgf8k8OSxe</span><br><span class="line">HWk1lLhdJfh96O/nEbz9AgMBAAGjggF0MIIBcDAPBgNVHRMBAf8EBTADAQH/MIIB</span><br><span class="line">LAYJYIZIAYb4QgENBIIBHROCARlUaGlzIFJvb3QgY2VydGlmaWNhdGUgd2FzIGdl</span><br><span class="line">bmVyYXRlZCBieSBDaGFybGVzIFByb3h5IGZvciBTU0wgUHJveHlpbmcuIElmIHRo</span><br><span class="line">aXMgY2VydGlmaWNhdGUgaXMgcGFydCBvZiBhIGNlcnRpZmljYXRlIGNoYWluLCB0</span><br><span class="line">aGlzIG1lYW5zIHRoYXQgeW91J3JlIGJyb3dzaW5nIHRocm91Z2ggQ2hhcmxlcyBQ</span><br><span class="line">cm94eSB3aXRoIFNTTCBQcm94eWluZyBlbmFibGVkIGZvciB0aGlzIHdlYnNpdGUu</span><br><span class="line">IFBsZWFzZSBzZWUgaHR0cDovL2NoYXJsZXNwcm94eS5jb20vc3NsIGZvciBtb3Jl</span><br><span class="line">IGluZm9ybWF0aW9uLjAOBgNVHQ8BAf8EBAMCAgQwHQYDVR0OBBYEFPDxZ1dwMgBq</span><br><span class="line">AuPwBWMv/Lcd7GOGMA0GCSqGSIb3DQEBCwUAA4IBAQA3nLkJtVRUUX94BJbryczU</span><br><span class="line">C0l5dqURDA6KKlNF3PtYvXxGGrdt7Ojkno9d2thUg1b+vKRwcY8tioJJHt01/QbH</span><br><span class="line">BK3uSIsdoxR+FY9Q7+hJc7XE8d+D3h4KlUgRY8EhCvBZMMo45O4t7wZYRbiCZh3q</span><br><span class="line">p4bayK99HZ8naYovYYK9oJiR8L41+YwuLZllkn5thJ+kvKw0NAgrP5YOsuxu+3DV</span><br><span class="line">uoDEhQPOwmPSVWq1JRAKMi8Ck9dfRYxZklLGZ+ZiT1L2ShyNuCLRKFHaP880RWJF</span><br><span class="line">uwuKep/FHqmCHWj5DumZF37jbsY56i13f723nSVZ56XJUq+yQ8KZzTqbEYBfC9Si</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>

<p>07cc5b45,就是我们获取到的文件名。</p>
<h3 id="修改文件名"><a href="#修改文件名" class="headerlink" title="修改文件名"></a>修改文件名</h3><p>就是将我们从charles中导出的xxxxx.pem文件名改为07cc5b45.0</p>
<h3 id="push到手机中（需要root）"><a href="#push到手机中（需要root）" class="headerlink" title="push到手机中（需要root）"></a>push到手机中（需要root）</h3><p>/system/etc/security/cacerts/</p>
<p>放入的过程中，上述文件后缀名的数字是为了防止文件名冲突的，比如如果两个证书算出的Hash值是一样的话，那么一个证书的后缀名数字可以设置成0，而另一个证书的后缀名数字可以设置成1（07cc5b45.1）。</p>
<h3 id="证书安装成功"><a href="#证书安装成功" class="headerlink" title="证书安装成功"></a>证书安装成功</h3><p>此时你应该可以在 设置-&gt;安全-&gt;信任的凭据 的系统标签页看到你新加入的证书，将其启用即可顺利抓包。</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/09/20/Android-7-0之后抓包证书无效的解决方案/certsuc.png" alt="certsuc" title class>
                <p>certsuc</p>
            </figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/shadowyspirits/article/details/79756274" target="_blank" rel="noopener">Android 7.0 之后抓包 unknown 和证书无效的解决方案（无需改代码)</a></p>
]]></content>
      
        <categories>
            
            <category> Charles </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Charles </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[gitlab api 使用问题]]></title>
      <url>/2019/08/29/gitlab-api-%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>在我们使用gitlab获取数据的时候，一般返回的数据都是每页20条数据，但是如果我们想一次获取获取多于20条怎么办？其实gitlab有两个参数可以设置。page和per_page，可以分别设置页数和条数，加到请求参数里即可。<br>API如下：</p>
<h2 id="Pagination"><a href="#Pagination" class="headerlink" title="Pagination"></a>Pagination</h2><p>Sometimes the returned result will span across many pages. When listing<br>resources you can pass the following parameters:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>page</td>
<td>Page number (default: 1)</td>
</tr>
<tr>
<td>per_page</td>
<td>Number of items to list per page (default: 20, max: 100)</td>
</tr>
</tbody></table>
]]></content>
      
        <categories>
            
            <category> GitLab </category>
            
        </categories>
        
        
        <tags>
            
            <tag> GitLab </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[通过ngrok搭建github的webhook]]></title>
      <url>/2019/08/21/%E9%80%9A%E8%BF%87ngrok%E6%90%AD%E5%BB%BAgithub%E7%9A%84webhook/</url>
      <content type="html"><![CDATA[<h2 id="WebHook"><a href="#WebHook" class="headerlink" title="WebHook"></a>WebHook</h2><h3 id="webhook概述"><a href="#webhook概述" class="headerlink" title="webhook概述"></a>webhook概述</h3><p>Webhooks allow external services to be notified when certain events happen. When the specified events happen, we’ll send a POST request to each of the URLs you provide. Learn more in our <a href="https://developer.github.com/webhooks/" target="_blank" rel="noopener">Webhooks Guide</a>.</p>
<p>Webhook顾名思义，其实就是一钩子。当我们在Github上做出某些特定操作时，可以触发钩子，去进行一些我们事先设定好的脚本，以达到某些特定功能（例如–前端项目自动发布）。</p>
<h3 id="github上webhook设置"><a href="#github上webhook设置" class="headerlink" title="github上webhook设置"></a>github上webhook设置</h3><figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/21/通过ngrok搭建github的webhook/webhooks.png" alt="webhooks" title class>
                <p>webhooks</p>
            </figure>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/21/通过ngrok搭建github的webhook/webhooksuc.png" alt="webhooksuc" title class>
                <p>webhooksuc</p>
            </figure>
<p>上图是我设置的好的webhook：可以看到我设置好了Payload URL和Content type.</p>
<p>Payload URL：就是我们要设置的钩子。</p>
<p>Content type：是在通知我们时传递的内容类型，一般情况下我们选择json数据格式。</p>
<p>Which events would you like to trigger this webhook?：这个选择比较重要，直接决定了当仓库发生什么变化时才对我们进行通知。</p>
<p>到此webhook添加完成。</p>
<h2 id="ngrok配置"><a href="#ngrok配置" class="headerlink" title="ngrok配置"></a>ngrok配置</h2><p>你设置好了钩子，那就需要当收到通知的时候进行接收处理。这个时候要注意，我们的钩子里要求你的服务器能连接到外网上。那怎么办，我们本地做服务器，肯定就收不到通知了。这个时候推荐一个神器ngrok，它就可以让你在本地就有一个外网地址。<a href="https://ngrok.com/download" target="_blank" rel="noopener">ngrok下载地址</a>.下载之后，在ngrok目录执行cmd：./ngrok http 4567，弹出下面的界面：</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/21/通过ngrok搭建github的webhook/ngrok.png" alt="ngrok" title class>
                <p>ngrok</p>
            </figure>
<p>可以看到我们本地服务器的地址被映射到了一个外网的地址。而这个<a href="http://4c8a9e3f.ngrok.io/就是上图中我们设置好的Payload" target="_blank" rel="noopener">http://4c8a9e3f.ngrok.io/就是上图中我们设置好的Payload</a> URL。</p>
<p>需要注意的是，当我们调试程序的时候，ngrok要打开，并且每次启动ngrok，外网地址都不同，每次启动有效时间为8小时。</p>
<h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><h3 id="bottle"><a href="#bottle" class="headerlink" title="bottle"></a>bottle</h3><p>Bottle是一个简单高效的遵循WSGI的微型python Web框架。bottle几乎没有任何依赖，而且只有一个文件。而相对于python默认的SimpleHTTPServer，功能更加丰富，实用更加灵活。如果只是开发一个小型的web程序，bottle已经足够了。但是这个服务器是阻塞式的，当一个用户请求的时候，其他用户的请求会被阻塞。可以很简单的使用其他的框架来配合bottle来实现无阻塞的web服务器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@route(&apos;/&apos;)</span><br><span class="line">@route(&apos;/index.html&apos;)</span><br><span class="line">def index():</span><br><span class="line">    return &apos;&lt;a href=&quot;/hello&quot;&gt;Go to Hello World Page&lt;/a&gt;&apos;</span><br><span class="line">@route(&apos;/hello&apos;)</span><br><span class="line">def hello():</span><br><span class="line">    return &apos;Hello World&apos;</span><br><span class="line">@route(&apos;/hello/&lt;id&gt;&apos;)</span><br><span class="line">def hello(id):</span><br><span class="line">    return &apos;Hello World&apos;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server_names = &#123;</span><br><span class="line">    &apos;cgi&apos;: CGIServer,</span><br><span class="line">    &apos;flup&apos;: FlupFCGIServer,</span><br><span class="line">    &apos;wsgiref&apos;: WSGIRefServer,</span><br><span class="line">    &apos;waitress&apos;: WaitressServer,</span><br><span class="line">    &apos;cherrypy&apos;: CherryPyServer,</span><br><span class="line">    &apos;paste&apos;: PasteServer,</span><br><span class="line">    &apos;fapws3&apos;: FapwsServer,</span><br><span class="line">    &apos;tornado&apos;: TornadoServer,</span><br><span class="line">    &apos;gae&apos;: AppEngineServer,</span><br><span class="line">    &apos;twisted&apos;: TwistedServer,</span><br><span class="line">    &apos;diesel&apos;: DieselServer,</span><br><span class="line">    &apos;meinheld&apos;: MeinheldServer,</span><br><span class="line">    &apos;gunicorn&apos;: GunicornServer,</span><br><span class="line">    &apos;eventlet&apos;: EventletServer,</span><br><span class="line">    &apos;gevent&apos;: GeventServer,</span><br><span class="line">    &apos;geventSocketIO&apos;:GeventSocketIOServer,</span><br><span class="line">    &apos;rocket&apos;: RocketServer,</span><br><span class="line">    &apos;bjoern&apos; : BjoernServer,</span><br><span class="line">    &apos;auto&apos;: AutoServer,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="paste"><a href="#paste" class="headerlink" title="paste"></a>paste</h3><table>
<tbody>
<tr><th style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);font-size:1.2em;">
名称</th>
<th style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);font-size:1.2em;">
主页</th>
<th style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);font-size:1.2em;">
介绍</th>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
cgi</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
 </td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
以CGI脚本运行</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
flup</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://trac.saddi.com/flup" rel="noopener" title="FLUP" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="c7b4b5077834a0ed1f5c0a4bca14f4cf" target="_blank">http://trac.saddi.com/flup</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
以FastCGI进程运行</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
gae</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://code.google.com/appengine/docs/python/overview.html" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="288e3bc1b26e0f48f7cbdecc50951f37" target="_blank">http://code.google.com/appengine/docs/python/overview.html</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
Google App Engine部属</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
wsgiref</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://docs.python.org/library/wsgiref.html" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="237e23e44a4365b59fcc33b28a891844" target="_blank">http://docs.python.org/library/wsgiref.html</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
默认为单线程的服务器</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
cherrypy</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://www.cherrypy.org/" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="72c50cd82c583c625d441d5022206177" target="_blank">http://www.cherrypy.org/</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
多线程服务器</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
paste</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://pythonpaste.org/" rel="noopener" title="http://pythonpaste.org/" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="71228709dedcb943fefeb0aec3bbd640" target="_blank">http://pythonpaste.org/</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
多线程服务器</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
rocket</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://pypi.python.org/pypi/rocket" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="cefb0f508a65db9aca1af3f78aa8df61" target="_blank">http://pypi.python.org/pypi/rocket</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
多线程服务器</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
gunicorn</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://pypi.python.org/pypi/gunicorn" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="9a58bd759fbfdbd2c6bb60b30eb894f3" target="_blank">http://pypi.python.org/pypi/gunicorn</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
部分用C编写</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
fapws3</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://www.fapws.org/" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="7380c8ebddf823041cb3785a15444f1e" target="_blank">http://www.fapws.org/</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
Asynchronous，基于C开发</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
tornado</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://www.tornadoweb.org/" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="28816a7f106f3be4d11b72a58302eabb" target="_blank">http://www.tornadoweb.org/</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
Asynchronous，服务了部分 FaceBook 的服务</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
twisted</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://twistedmatrix.com/" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="c11813c5b43ff62fd484194d38ea9b09" target="_blank">http://twistedmatrix.com/</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
Asynchronous</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
gevent</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://www.gevent.org/" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="8739ffd1da6ba93b622d20965903c018" target="_blank">http://dieselweb.org/</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
Asynchronous，基于Greenlet</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
diesel</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://dieselweb.org/" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="8739ffd1da6ba93b622d20965903c018" target="_blank">http://dieselweb.org/</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
Asynchronous，基于Greenlet</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
meinheld</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://pypi.python.org/pypi/meinheld" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="e8fc885d48908fbe74c4848d401bb8f0" target="_blank">http://pypi.python.org/pypi/meinheld</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
Asynchronous，部分基于C开发</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
bjoern</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
<a href="http://pypi.python.org/pypi/bjoern" rel="noopener" style="text-decoration:none;color:rgb(38,94,21);border-bottom-color:rgb(153,102,51);border-bottom-width:1px;border-bottom-style:dashed;" data-token="f9fa6703b208a2b47317f58614c91139" target="_blank">http://pypi.python.org/pypi/bjoern</a></td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
Asynchronous，非常快，基于C开发</td>
</tr>

<tr><td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
auto</td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
 </td>
<td style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);">
自动选择一个可用的服务器</td>
</tr>
</tbody>
</table>
可以看到，bottle适配的web服务器很丰富。工作模式也很全面，有多线程的（如paste）、有多进程模式的（如gunicorn）、也有基于协程的（如gevent）。

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>nohup python3 -u githook.py &gt; nohup.log 2&gt;&amp;1 &amp;</p>
<p>nohup：放在命令的开头，表示不挂起（no hang up），也即，关闭终端或者退出某个账号，进程也继续保持运行状态。</p>
<p>-u ：不启用缓冲。</p>
<p>nohup.log：日志文件</p>
<p>2&gt;&amp;1：也就表示将错误重定向到标准输出上</p>
<p>&amp; ：放在命令到结尾，表示后台运行，防止终端一直被某个进程占用，这样终端可以执行别到任务。</p>
<p><strong>注意使用nohup命令后台运行命令之后，需要使用exit正常退出当前账户，这样才能保证命令一直在后台运行。否则当前账户非正常退出或者结束的时候，命令还是会结束。</strong></p>
<h3 id="事例"><a href="#事例" class="headerlink" title="事例"></a>事例</h3><p>通过python配置一个简单的服务器，用于接收通知信息。具体事例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@route(&apos;/payload&apos;, method=[&apos;GET&apos;,&apos;POST&apos;])</span><br><span class="line">def payload():</span><br><span class="line">    print(&apos;payload----request.json:&apos;+request.json.__str__())</span><br><span class="line">    print(&apos;payload----request.headers.X-GitHub-Event:&apos;+request.get_header(&apos;X-GitHub-Event&apos;))</span><br><span class="line">    print(&apos;payload----request.headers.X-GitHub-Delivery:&apos;+request.get_header(&apos;X-GitHub-Delivery&apos;))</span><br><span class="line">    return &quot;hello world&quot;</span><br></pre></td></tr></table></figure>

<p>这个时候我们手动push一个信息，打印信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;ref&quot;: &quot;refs/heads/master&quot;,</span><br><span class="line">	&quot;before&quot;: &quot;fc7585b3799386a625a2584b75c3e94424212889&quot;,</span><br><span class="line">	&quot;after&quot;: &quot;db7bbed15a40cec6c3cbbd778877fee8941bf86d&quot;,</span><br><span class="line">	&quot;created&quot;: false,</span><br><span class="line">	&quot;deleted&quot;: false,</span><br><span class="line">	&quot;forced&quot;: false,</span><br><span class="line">	&quot;base_ref&quot;: &quot;none&quot;,</span><br><span class="line">	&quot;compare&quot;: &quot;https://github.com/nunu03/photo/compare/fc7585b37993...db7bbed15a40&quot;,</span><br><span class="line">	&quot;commits&quot;: [&#123;</span><br><span class="line">		&quot;id&quot;: &quot;db7bbed15a40cec6c3cbbd778877fee8941bf86d&quot;,</span><br><span class="line">		&quot;tree_id&quot;: &quot;8394661d6d3855d60e431ad5a73a88b03e6944ab&quot;,</span><br><span class="line">		&quot;distinct&quot;: true,</span><br><span class="line">		&quot;message&quot;: &quot;6 update and commit&quot;,</span><br><span class="line">		&quot;timestamp&quot;: &quot;2019-08-21T18:04:00+08:00&quot;,</span><br><span class="line">		&quot;url&quot;: &quot;https://github.com/nunu03/photo/commit/db7bbed15a40cec6c3cbbd778877fee8941bf86d&quot;,</span><br><span class="line">		&quot;author&quot;: &#123;</span><br><span class="line">			&quot;name&quot;: &quot;YlJava110&quot;,</span><br><span class="line">			&quot;email&quot;: &quot;594531261@qq.com&quot;,</span><br><span class="line">			&quot;username&quot;: &quot;nunu03&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;committer&quot;: &#123;</span><br><span class="line">			&quot;name&quot;: &quot;YlJava110&quot;,</span><br><span class="line">			&quot;email&quot;: &quot;594531261@qq.com&quot;,</span><br><span class="line">			&quot;username&quot;: &quot;nunu03&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;added&quot;: [],</span><br><span class="line">		&quot;removed&quot;: [],</span><br><span class="line">		&quot;modified&quot;: [&quot;P2.docx&quot;]</span><br><span class="line">	&#125;],</span><br><span class="line">	&quot;head_commit&quot;: &#123;</span><br><span class="line">		&quot;id&quot;: &quot;db7bbed15a40cec6c3cbbd778877fee8941bf86d&quot;,</span><br><span class="line">		&quot;tree_id&quot;: &quot;8394661d6d3855d60e431ad5a73a88b03e6944ab&quot;,</span><br><span class="line">		&quot;distinct&quot;: true,</span><br><span class="line">		&quot;message&quot;: &quot;6 update and commit&quot;,</span><br><span class="line">		&quot;timestamp&quot;: &quot;2019-08-21T18:04:00+08:00&quot;,</span><br><span class="line">		&quot;url&quot;: &quot;https://github.com/nunu03/photo/commit/db7bbed15a40cec6c3cbbd778877fee8941bf86d&quot;,</span><br><span class="line">		&quot;author&quot;: &#123;</span><br><span class="line">			&quot;name&quot;: &quot;YlJava110&quot;,</span><br><span class="line">			&quot;email&quot;: &quot;594531261@qq.com&quot;,</span><br><span class="line">			&quot;username&quot;: &quot;nunu03&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;committer&quot;: &#123;</span><br><span class="line">			&quot;name&quot;: &quot;YlJava110&quot;,</span><br><span class="line">			&quot;email&quot;: &quot;594531261@qq.com&quot;,</span><br><span class="line">			&quot;username&quot;: &quot;nunu03&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;added&quot;: [],</span><br><span class="line">		&quot;removed&quot;: [],</span><br><span class="line">		&quot;modified&quot;: [&quot;P2.docx&quot;]</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;repository&quot;: &#123;</span><br><span class="line">		&quot;id&quot;: 158326464,</span><br><span class="line">		&quot;node_id&quot;: &quot;MDEwOlJlcG9zaXRvcnkxNTgzMjY0NjQ=&quot;,</span><br><span class="line">		&quot;name&quot;: &quot;photo&quot;,</span><br><span class="line">		&quot;full_name&quot;: &quot;nunu03/photo&quot;,</span><br><span class="line">		&quot;private&quot;: false,</span><br><span class="line">		&quot;owner&quot;: &#123;</span><br><span class="line">			&quot;name&quot;: &quot;nunu03&quot;,</span><br><span class="line">			&quot;email&quot;: &quot;594531261@qq.com&quot;,</span><br><span class="line">			&quot;login&quot;: &quot;nunu03&quot;,</span><br><span class="line">			&quot;id&quot;: 9353063,</span><br><span class="line">			&quot;node_id&quot;: &quot;MDQ6VXNlcjkzNTMwNjM=&quot;,</span><br><span class="line">			&quot;avatar_url&quot;: &quot;https://avatars0.githubusercontent.com/u/9353063?v=4&quot;,</span><br><span class="line">			&quot;gravatar_id&quot;: &quot;&quot;,</span><br><span class="line">			&quot;url&quot;: &quot;https://api.github.com/users/nunu03&quot;,</span><br><span class="line">			&quot;html_url&quot;: &quot;https://github.com/nunu03&quot;,</span><br><span class="line">			&quot;followers_url&quot;: &quot;https://api.github.com/users/nunu03/followers&quot;,</span><br><span class="line">			&quot;following_url&quot;: &quot;https://api.github.com/users/nunu03/following&#123;/other_user&#125;&quot;,</span><br><span class="line">			&quot;gists_url&quot;: &quot;https://api.github.com/users/nunu03/gists&#123;/gist_id&#125;&quot;,</span><br><span class="line">			&quot;starred_url&quot;: &quot;https://api.github.com/users/nunu03/starred&#123;/owner&#125;&#123;/repo&#125;&quot;,</span><br><span class="line">			&quot;subscriptions_url&quot;: &quot;https://api.github.com/users/nunu03/subscriptions&quot;,</span><br><span class="line">			&quot;organizations_url&quot;: &quot;https://api.github.com/users/nunu03/orgs&quot;,</span><br><span class="line">			&quot;repos_url&quot;: &quot;https://api.github.com/users/nunu03/repos&quot;,</span><br><span class="line">			&quot;events_url&quot;: &quot;https://api.github.com/users/nunu03/events&#123;/privacy&#125;&quot;,</span><br><span class="line">			&quot;received_events_url&quot;: &quot;https://api.github.com/users/nunu03/received_events&quot;,</span><br><span class="line">			&quot;type&quot;: &quot;User&quot;,</span><br><span class="line">			&quot;site_admin&quot;: false</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;html_url&quot;: &quot;https://github.com/nunu03/photo&quot;,</span><br><span class="line">		&quot;description&quot;: &quot;photo upload&quot;,</span><br><span class="line">		&quot;fork&quot;: false,</span><br><span class="line">		&quot;url&quot;: &quot;https://github.com/nunu03/photo&quot;,</span><br><span class="line">		&quot;forks_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/forks&quot;,</span><br><span class="line">		&quot;keys_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/keys&#123;/key_id&#125;&quot;,</span><br><span class="line">		&quot;collaborators_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/collaborators&#123;/collaborator&#125;&quot;,</span><br><span class="line">		&quot;teams_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/teams&quot;,</span><br><span class="line">		&quot;hooks_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/hooks&quot;,</span><br><span class="line">		&quot;issue_events_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/issues/events&#123;/number&#125;&quot;,</span><br><span class="line">		&quot;events_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/events&quot;,</span><br><span class="line">		&quot;assignees_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/assignees&#123;/user&#125;&quot;,</span><br><span class="line">		&quot;branches_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/branches&#123;/branch&#125;&quot;,</span><br><span class="line">		&quot;tags_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/tags&quot;,</span><br><span class="line">		&quot;blobs_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/git/blobs&#123;/sha&#125;&quot;,</span><br><span class="line">		&quot;git_tags_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/git/tags&#123;/sha&#125;&quot;,</span><br><span class="line">		&quot;git_refs_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/git/refs&#123;/sha&#125;&quot;,</span><br><span class="line">		&quot;trees_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/git/trees&#123;/sha&#125;&quot;,</span><br><span class="line">		&quot;statuses_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/statuses/&#123;sha&#125;&quot;,</span><br><span class="line">		&quot;languages_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/languages&quot;,</span><br><span class="line">		&quot;stargazers_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/stargazers&quot;,</span><br><span class="line">		&quot;contributors_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/contributors&quot;,</span><br><span class="line">		&quot;subscribers_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/subscribers&quot;,</span><br><span class="line">		&quot;subscription_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/subscription&quot;,</span><br><span class="line">		&quot;commits_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/commits&#123;/sha&#125;&quot;,</span><br><span class="line">		&quot;git_commits_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/git/commits&#123;/sha&#125;&quot;,</span><br><span class="line">		&quot;comments_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/comments&#123;/number&#125;&quot;,</span><br><span class="line">		&quot;issue_comment_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/issues/comments&#123;/number&#125;&quot;,</span><br><span class="line">		&quot;contents_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/contents/&#123;+path&#125;&quot;,</span><br><span class="line">		&quot;compare_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/compare/&#123;base&#125;...&#123;head&#125;&quot;,</span><br><span class="line">		&quot;merges_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/merges&quot;,</span><br><span class="line">		&quot;archive_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/&#123;archive_format&#125;&#123;/ref&#125;&quot;,</span><br><span class="line">		&quot;downloads_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/downloads&quot;,</span><br><span class="line">		&quot;issues_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/issues&#123;/number&#125;&quot;,</span><br><span class="line">		&quot;pulls_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/pulls&#123;/number&#125;&quot;,</span><br><span class="line">		&quot;milestones_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/milestones&#123;/number&#125;&quot;,</span><br><span class="line">		&quot;notifications_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/notifications&#123;?since,all,participating&#125;&quot;,</span><br><span class="line">		&quot;labels_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/labels&#123;/name&#125;&quot;,</span><br><span class="line">		&quot;releases_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/releases&#123;/id&#125;&quot;,</span><br><span class="line">		&quot;deployments_url&quot;: &quot;https://api.github.com/repos/nunu03/photo/deployments&quot;,</span><br><span class="line">		&quot;created_at&quot;: 1542684949,</span><br><span class="line">		&quot;updated_at&quot;: &quot;2019-08-21T10:02:17Z&quot;,</span><br><span class="line">		&quot;pushed_at&quot;: 1566381860,</span><br><span class="line">		&quot;git_url&quot;: &quot;git://github.com/nunu03/photo.git&quot;,</span><br><span class="line">		&quot;ssh_url&quot;: &quot;git@github.com:nunu03/photo.git&quot;,</span><br><span class="line">		&quot;clone_url&quot;: &quot;https://github.com/nunu03/photo.git&quot;,</span><br><span class="line">		&quot;svn_url&quot;: &quot;https://github.com/nunu03/photo&quot;,</span><br><span class="line">		&quot;homepage&quot;: &quot;none&quot;,</span><br><span class="line">		&quot;size&quot;: 382,</span><br><span class="line">		&quot;stargazers_count&quot;: 0,</span><br><span class="line">		&quot;watchers_count&quot;: 0,</span><br><span class="line">		&quot;language&quot;: &quot;none&quot;,</span><br><span class="line">		&quot;has_issues&quot;: true,</span><br><span class="line">		&quot;has_projects&quot;: true,</span><br><span class="line">		&quot;has_downloads&quot;: true,</span><br><span class="line">		&quot;has_wiki&quot;: true,</span><br><span class="line">		&quot;has_pages&quot;: false,</span><br><span class="line">		&quot;forks_count&quot;: 0,</span><br><span class="line">		&quot;mirror_url&quot;: &quot;none&quot;,</span><br><span class="line">		&quot;archived&quot;: false,</span><br><span class="line">		&quot;disabled&quot;: false,</span><br><span class="line">		&quot;open_issues_count&quot;: 0,</span><br><span class="line">		&quot;license&quot;: &quot;none&quot;,</span><br><span class="line">		&quot;forks&quot;: 0,</span><br><span class="line">		&quot;open_issues&quot;: 0,</span><br><span class="line">		&quot;watchers&quot;: 0,</span><br><span class="line">		&quot;default_branch&quot;: &quot;master&quot;,</span><br><span class="line">		&quot;stargazers&quot;: 0,</span><br><span class="line">		&quot;master_branch&quot;: &quot;master&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;pusher&quot;: &#123;</span><br><span class="line">		&quot;name&quot;: &quot;nunu03&quot;,</span><br><span class="line">		&quot;email&quot;: &quot;594531261@qq.com&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;sender&quot;: &#123;</span><br><span class="line">		&quot;login&quot;: &quot;nunu03&quot;,</span><br><span class="line">		&quot;id&quot;: 9353063,</span><br><span class="line">		&quot;node_id&quot;: &quot;MDQ6VXNlcjkzNTMwNjM=&quot;,</span><br><span class="line">		&quot;avatar_url&quot;: &quot;https://avatars0.githubusercontent.com/u/9353063?v=4&quot;,</span><br><span class="line">		&quot;gravatar_id&quot;: &quot;&quot;,</span><br><span class="line">		&quot;url&quot;: &quot;https://api.github.com/users/nunu03&quot;,</span><br><span class="line">		&quot;html_url&quot;: &quot;https://github.com/nunu03&quot;,</span><br><span class="line">		&quot;followers_url&quot;: &quot;https://api.github.com/users/nunu03/followers&quot;,</span><br><span class="line">		&quot;following_url&quot;: &quot;https://api.github.com/users/nunu03/following&#123;/other_user&#125;&quot;,</span><br><span class="line">		&quot;gists_url&quot;: &quot;https://api.github.com/users/nunu03/gists&#123;/gist_id&#125;&quot;,</span><br><span class="line">		&quot;starred_url&quot;: &quot;https://api.github.com/users/nunu03/starred&#123;/owner&#125;&#123;/repo&#125;&quot;,</span><br><span class="line">		&quot;subscriptions_url&quot;: &quot;https://api.github.com/users/nunu03/subscriptions&quot;,</span><br><span class="line">		&quot;organizations_url&quot;: &quot;https://api.github.com/users/nunu03/orgs&quot;,</span><br><span class="line">		&quot;repos_url&quot;: &quot;https://api.github.com/users/nunu03/repos&quot;,</span><br><span class="line">		&quot;events_url&quot;: &quot;https://api.github.com/users/nunu03/events&#123;/privacy&#125;&quot;,</span><br><span class="line">		&quot;received_events_url&quot;: &quot;https://api.github.com/users/nunu03/received_events&quot;,</span><br><span class="line">		&quot;type&quot;: &quot;User&quot;,</span><br><span class="line">		&quot;site_admin&quot;: false</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload----request.headers.X-GitHub-Event:push</span><br><span class="line">payload----request.headers.X-GitHub-Delivery:7a8185c4-c40a-11e9-8ed7-401aabcf3ce7</span><br></pre></td></tr></table></figure>

<p>事件的驱动信息可以在webhook中查看：</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/21/通过ngrok搭建github的webhook/webhookimage.jpg" alt="webhookimage" title class>
                <p>webhookimage</p>
            </figure>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><p>1.我们的路由@route(‘/payload’, method=[‘GET’,’POST’])是必填的，如果丢失method,我们将不能受到请求。同时payload，要与Payload URL中设置的名一样。</p>
<p>2.requests</p>
<p>print(r):&lt;Response [200]&gt;<br>print(r.json):{‘id’: 132968, ‘iid’: 2182437, ‘project_id’: 15509,<br>print(r.text):{“id”:132968,”iid”:2182437,”project_id”:15509,<br>json.dumps(r.json())</p>
<p>3.can only concatenate str (not “int”) to str</p>
<p>print(‘payload—-projectid:%d’ % projectid)</p>
<h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><p>1.Could not fetch URL <a href="https://pypi.python.org/simple/requests/" target="_blank" rel="noopener">https://pypi.python.org/simple/requests/</a>: There was a problem confirming the ssl certificate: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:777) - skipping<br>  Could not find a version that satisfies the requirement requests (from versions: )<br>No matching distribution found for requests</p>
<p>解决方法：pip3 install requests  -i  <a href="http://pypi.douban.com/simple" target="_blank" rel="noopener">http://pypi.douban.com/simple</a> –trusted-host=pypi.douban.com</p>
<p>2.升级pip</p>
<p>解决方法：尝试使用如下指令</p>
<p>pip install -U pip</p>
<p>sudo easy_install –upgrade pip</p>
<p>3.405 Method Not Allowed</p>
<p>路由名不对与Payload URL中设置的名不一样，或者method丢失。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.jianshu.com/p/55209f1031e8" target="_blank" rel="noopener">webhook小试水(无需外网服务器)</a></p>
]]></content>
      
        <categories>
            
            <category> WebHook </category>
            
            <category> ngrok </category>
            
        </categories>
        
        
        <tags>
            
            <tag> WebHook </tag>
            
            <tag> ngrok </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Charles设置]]></title>
      <url>/2019/08/16/charles%E4%BF%AE%E6%94%B9%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0/</url>
      <content type="html"><![CDATA[<h2 id="修改请求参数"><a href="#修改请求参数" class="headerlink" title="修改请求参数"></a>修改请求参数</h2><p>先点击选定自己想要修改的该条请求，然后右击该条请求选择Compose，则会出现以下界面，便可以开始修改该请求了.</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/16/charles修改请求参数/charles.png" alt="charles" title class>
                <p>charles</p>
            </figure>
<h2 id="弱网设置"><a href="#弱网设置" class="headerlink" title="弱网设置"></a>弱网设置</h2><p>我们在测试过程中，需要测试一些网络不好时候的异常场景，我们就可以通过设置Charles，模拟2G、3G的网络情况，设置一些上下行速率，设置一些丢包率。这些设置有行业标准，可以参考行业标准。</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/16/charles修改请求参数/throttle_set.png" alt="throttle_set" title class>
                <p>throttle_set</p>
            </figure>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/16/charles修改请求参数/throttle_input.png" alt="throttle_input" title class>
                <p>throttle_input</p>
            </figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/weixin_40669017/article/details/81975000" target="_blank" rel="noopener">Charles抓包、修改请求、修改返回、弱网设置</a></p>
]]></content>
      
        <categories>
            
            <category> Charles </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Charles </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Fragment和Activity生命周期]]></title>
      <url>/2019/08/08/Fragment%E5%92%8CActivity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
      <content type="html"><![CDATA[<h2 id="Fragment生命周期"><a href="#Fragment生命周期" class="headerlink" title="Fragment生命周期"></a>Fragment生命周期</h2><figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/08/Fragment和Activity生命周期/fragment.png" alt="fragment" title class>
                <p>fragment</p>
            </figure>
<h2 id="Fragment与Activity生命周期比较"><a href="#Fragment与Activity生命周期比较" class="headerlink" title="Fragment与Activity生命周期比较"></a>Fragment与Activity生命周期比较</h2><figure class="image-box">
                <img src="http://nunu03.github.io/2019/08/08/Fragment和Activity生命周期/activity.png" alt="activity" title class>
                <p>activity</p>
            </figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/asdf717/article/details/51383750" target="_blank" rel="noopener">Android Fragment 生命周期onCreatView、onViewCreated</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[aar依赖引用关系]]></title>
      <url>/2019/07/23/aar%E4%BE%9D%E8%B5%96%E5%BC%95%E7%94%A8%E5%85%B3%E7%B3%BB/</url>
      <content type="html"><![CDATA[<h2 id="依赖关系查看"><a href="#依赖关系查看" class="headerlink" title="依赖关系查看"></a>依赖关系查看</h2><h3 id="Gradle-View"><a href="#Gradle-View" class="headerlink" title="Gradle View"></a>Gradle View</h3><p>在AS中安装Gradle View插件，安装完重启。</p>
<p>在AS面板中-&gt;View-&gt;Tool Windows-&gt;Gradle View查看。</p>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><p>./gradlew -q :app:dependencies<br>//查看app模块所有依赖，包含依赖的依赖</p>
<p> ./gradlew : app:dependencies –configuration implementation<br> //查看app模块的依赖，不包含依赖的依赖</p>
<h2 id="多版本依赖"><a href="#多版本依赖" class="headerlink" title="多版本依赖"></a>多版本依赖</h2><blockquote>
<p>依赖库有版本冲突时，默认使用高版本中的依赖（注意：是引用库的高版本中的依赖），如果项目中指定版本高于依赖中，优先用项目中指定的版本<br>如果想指定使用引入库中版本，使用force参数</p>
<blockquote>
<p>总结：</p>
<p>1.a = 引用库依赖（高）&gt;引用库依赖（低）;</p>
<p>2.force = true 使用指定;</p>
<p>3.引用&gt; a 使用引用，否则使用a</p>
</blockquote>
</blockquote>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/23/aar依赖引用关系/aar.jpg" alt="aar" title class>
                <p>aar</p>
            </figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/weixin_33714884/article/details/90770965" target="_blank" rel="noopener">aar依赖关系解析</a></p>
<p><a href="https://www.jianshu.com/p/3b29f6890eac" target="_blank" rel="noopener">Android Studio查看第三方库依赖树</a></p>
<p><a href="https://blog.csdn.net/jifenglie/article/details/81390517" target="_blank" rel="noopener">Gradle查看第三方依赖关系图</a></p>
]]></content>
      
        <categories>
            
            <category> Gradle </category>
            
        </categories>
        
        
        <tags>
            
            <tag> aar </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Flutter 配置]]></title>
      <url>/2019/07/12/Flutter-%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h2 id="下载SDK"><a href="#下载SDK" class="headerlink" title="下载SDK"></a>下载SDK</h2><p><a href="https://flutter.dev/docs/development/tools/sdk/releases?tab=macos#macos" target="_blank" rel="noopener">SDK下载地址</a><br>对应下载合适的平台即可，可能由于网速等原因，下载详细未显示，所以我用的是直接git clone。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b master https://github.com/flutter/flutter.git</span><br></pre></td></tr></table></figure>

<h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ open .bash_profile</span><br></pre></td></tr></table></figure>

<p>在.bash_profile中添加flutter的path</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#flutter</span><br><span class="line">export PATH=/Users/xxxxxxx/flutter/bin:$PATH</span><br></pre></td></tr></table></figure>

<p>更新环境配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ source .bash_profile</span><br><span class="line">$ echo $PATH</span><br></pre></td></tr></table></figure>

<p>执行flutter doctor或flutter –version命令来查看是否还需要安装其它依赖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Downloading Dart SDK from Flutter engine d1dcd1848633c5764e23313823445cbcba451a59...</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:--  0:00:39 --:--:--     0</span><br><span class="line">curl: (56) SSLRead() return error -9806</span><br><span class="line"></span><br><span class="line">Failed to retrieve the Dart SDK from: https://storage.googleapis.com/flutter_infra/flutter/d1dcd1848633c5764e23313823445cbcba451a59/dart-sdk-darwin-x64.zip</span><br><span class="line">If you&apos;re located in China, please see this page:</span><br><span class="line">  https://flutter.dev/community/china</span><br></pre></td></tr></table></figure>

<p><strong>解决方式</strong>:由于在国内访问Flutter有时可能会受到限制，Flutter官方为中国开发者搭建了临时镜像，大家可以将如下环境变量加入到用户环境变量中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line">export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br></pre></td></tr></table></figure>

<p>正常下载如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">chenyulong01deMacBook-Pro:flutter chenyulong01$ flutter doctor</span><br><span class="line">Downloading Dart SDK from Flutter engine d1dcd1848633c5764e23313823445cbcba451a59...</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  120M  100  120M    0     0   655k      0  0:03:07  0:03:07 --:--:--  656k</span><br><span class="line">Building flutter tool...</span><br><span class="line"></span><br><span class="line">  ╔════════════════════════════════════════════════════════════════════════════╗</span><br><span class="line">  ║                 Welcome to Flutter! - https://flutter.dev                  ║</span><br><span class="line">  ║                                                                            ║</span><br><span class="line">  ║ The Flutter tool anonymously reports feature usage statistics and crash    ║</span><br><span class="line">  ║ reports to Google in order to help Google contribute improvements to       ║</span><br><span class="line">  ║ Flutter over time.                                                         ║</span><br><span class="line">  ║                                                                            ║</span><br><span class="line">  ║ Read about data we send with crash reports:                                ║</span><br><span class="line">  ║ https://github.com/flutter/flutter/wiki/Flutter-CLI-crash-reporting        ║</span><br><span class="line">  ║                                                                            ║</span><br><span class="line">  ║ See Google&apos;s privacy policy:                                               ║</span><br><span class="line">  ║ https://www.google.com/intl/en/policies/privacy/                           ║</span><br><span class="line">  ║                                                                            ║</span><br><span class="line">  ║ Use &quot;flutter config --no-analytics&quot; to disable analytics and crash         ║</span><br><span class="line">  ║ reporting.                                                                 ║</span><br><span class="line">  ╚════════════════════════════════════════════════════════════════════════════╝</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Flutter assets will be downloaded from https://storage.flutter-io.cn. Make sure</span><br><span class="line">you trust this source!</span><br><span class="line">Downloading Material fonts...                                       2.8s</span><br><span class="line">Downloading android-arm-profile/darwin-x64 tools...                 4.5s</span><br><span class="line">Downloading android-arm-release/darwin-x64 tools...                 3.6s</span><br><span class="line">Downloading android-arm64-profile/darwin-x64 tools...               4.6s</span><br><span class="line">Downloading android-arm64-release/darwin-x64 tools...               3.8s</span><br><span class="line">Downloading android-x86 tools...                                   24.8s</span><br><span class="line">Downloading android-x64 tools...                                   25.9s</span><br><span class="line">Downloading android-arm tools...                                   11.6s</span><br><span class="line">Download failed -- attempting retry 1 in 1 second...                    </span><br><span class="line">Downloading android-arm-profile tools...                            9.1s</span><br><span class="line">Downloading android-arm-release tools...                            6.0s</span><br><span class="line">Downloading android-arm64 tools...                                 12.3s</span><br><span class="line">Downloading android-arm64-profile tools...                          7.8s</span><br><span class="line">Downloading android-arm64-release tools...                          6.1s</span><br><span class="line">Downloading Gradle Wrapper...                                       0.2s</span><br><span class="line">Downloading package sky_engine...                                   1.4s</span><br><span class="line">Downloading common tools...                                        15.0s</span><br><span class="line">Downloading common tools...                                        15.1s</span><br><span class="line">Downloading darwin-x64 tools...                                    49.2s</span><br><span class="line">Doctor summary (to see all details, run flutter doctor -v):</span><br><span class="line">[✓] Flutter (Channel master, v1.8.2-pre.56, on Mac OS X 10.12.6 16G29, locale</span><br><span class="line">    zh-Hans-CN)</span><br><span class="line"> </span><br><span class="line">[✓] Android toolchain - develop for Android devices (Android SDK version 28.0.3)</span><br><span class="line">[✗] Xcode - develop for iOS and macOS</span><br><span class="line">    ✗ Xcode installation is incomplete; a full installation is necessary for iOS</span><br><span class="line">      development.</span><br><span class="line">      Download at: https://developer.apple.com/xcode/download/</span><br><span class="line">      Or install Xcode via the App Store.</span><br><span class="line">      Once installed, run:</span><br><span class="line">        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer</span><br><span class="line">    ✗ CocoaPods not installed.</span><br><span class="line">        CocoaPods is used to retrieve the iOS and macOS platform side&apos;s plugin</span><br><span class="line">        code that responds to your plugin usage on the Dart side.</span><br><span class="line">        Without CocoaPods, plugins will not work on iOS or macOS.</span><br><span class="line">        For more info, see https://flutter.dev/platform-plugins</span><br><span class="line">      To install:</span><br><span class="line">        brew install cocoapods</span><br><span class="line">        pod setup</span><br><span class="line">[✗] iOS tools - develop for iOS devices</span><br><span class="line">    ✗ libimobiledevice and ideviceinstaller are not installed. To install with</span><br><span class="line">      Brew, run:</span><br><span class="line">        brew update</span><br><span class="line">        brew install --HEAD usbmuxd</span><br><span class="line">        brew link usbmuxd</span><br><span class="line">        brew install --HEAD libimobiledevice</span><br><span class="line">        brew install ideviceinstaller</span><br><span class="line">    ✗ ios-deploy not installed. To install:</span><br><span class="line">        brew install ios-deploy</span><br><span class="line">[✓] Chrome - develop for the web</span><br><span class="line">[!] Android Studio (version 3.3)</span><br><span class="line">    ✗ Flutter plugin not installed; this adds Flutter specific functionality.</span><br><span class="line">    ✗ Dart plugin not installed; this adds Dart specific functionality.</span><br><span class="line">[✓] Connected device (3 available)</span><br><span class="line"></span><br><span class="line">! Doctor found issues in 3 categories.</span><br><span class="line">chenyulong01deMacBook-Pro:flutter chenyulong01$</span><br></pre></td></tr></table></figure>

<h2 id="更新flutter及其依赖"><a href="#更新flutter及其依赖" class="headerlink" title="更新flutter及其依赖"></a>更新flutter及其依赖</h2><h3 id="更新Flutter"><a href="#更新Flutter" class="headerlink" title="更新Flutter"></a>更新Flutter</h3><figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/12/Flutter-配置/fu.jpg" alt title class>
                <p></p>
            </figure>

<h3 id="更新Dart及其他依赖"><a href="#更新Dart及其他依赖" class="headerlink" title="更新Dart及其他依赖"></a>更新Dart及其他依赖</h3><figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/12/Flutter-配置/fdu.jpg" alt title class>
                <p></p>
            </figure>

<h2 id="AS-Flutter插件安装配置"><a href="#AS-Flutter插件安装配置" class="headerlink" title="AS Flutter插件安装配置"></a>AS Flutter插件安装配置</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/12/Flutter-配置/af.jpg" alt title class>
                <p></p>
            </figure>
<h3 id="配置SDK"><a href="#配置SDK" class="headerlink" title="配置SDK"></a>配置SDK</h3><figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/12/Flutter-配置/afd.jpg" alt title class>
                <p></p>
            </figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://book.flutterchina.club/" target="_blank" rel="noopener">Flutter中文网</a><br><a href="https://flutter.dev/docs/get-started/codelab" target="_blank" rel="noopener">Flutter官方事例</a></p>
]]></content>
      
        <categories>
            
            <category> Flutter </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Flutter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android API Level对应Android版本一览表]]></title>
      <url>/2019/07/05/Android-API-Level%E5%AF%B9%E5%BA%94Android%E7%89%88%E6%9C%AC%E4%B8%80%E8%A7%88%E8%A1%A8/</url>
      <content type="html"><![CDATA[<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/05/Android-API-Level对应Android版本一览表/api1.jpg" alt="api-1" title class>
                <p>api-1</p>
            </figure>
<a id="more"></a>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/05/Android-API-Level对应Android版本一览表/api2.jpg" alt="api-2" title class>
                <p>api-2</p>
            </figure>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[腾讯加固脱壳使用事例]]></title>
      <url>/2019/07/03/tencentfdex/</url>
      <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文只介绍具体的原理和实现，不涉及Xposed相关技术点。想要了解Xposed具体配置和实现的请参考<a href="http://nunu03.github.io/2019/07/02/xposed/">Xposed的配置与简单使用</a></p>
<a id="more"></a>

<h3 id="直接反编译apk"><a href="#直接反编译apk" class="headerlink" title="直接反编译apk"></a>直接反编译apk</h3><figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/03/tencentfdex/apkjadx.jpg" alt="apk-jadx" title class>
                <p>apk-jadx</p>
            </figure>


<h2 id="脱壳工具FDex2"><a href="#脱壳工具FDex2" class="headerlink" title="脱壳工具FDex2"></a>脱壳工具FDex2</h2><figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/03/tencentfdex/fdex2.jpeg" alt="fdex2" title class>
                <p>fdex2</p>
            </figure>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/03/tencentfdex/dexpath.jpeg" alt="dexpath" title class>
                <p>dexpath</p>
            </figure>
<h3 id="脱壳流程"><a href="#脱壳流程" class="headerlink" title="脱壳流程"></a>脱壳流程</h3><h4 id="第一步、激活"><a href="#第一步、激活" class="headerlink" title="第一步、激活"></a>第一步、激活</h4><p>FDex2和需要脱壳的应用都安装到手机上。在Xposed install模块中勾选FDex2，重启手机。</p>
<h4 id="第二步、选择软件"><a href="#第二步、选择软件" class="headerlink" title="第二步、选择软件"></a>第二步、选择软件</h4><p>然后打开FDex2应用，在应用列表中选择需要脱壳的应用，保存dex即可。</p>
<h4 id="第三步、运行软件"><a href="#第三步、运行软件" class="headerlink" title="第三步、运行软件"></a>第三步、运行软件</h4><p>运行要脱壳的软件，不打开运行软件是无法脱出壳的</p>
<h4 id="第四步、dex目录"><a href="#第四步、dex目录" class="headerlink" title="第四步、dex目录"></a>第四步、dex目录</h4><p>找到dex目录，这里的dex就是脱壳后的dex文件，也就是我即将hook的dex文件。目录一般是/data/user/0/com.luhu.package.xxx。</p>
<h2 id="hook过程"><a href="#hook过程" class="headerlink" title="hook过程"></a>hook过程</h2><p>由于被腾讯加固，所以第一步是需要获取对应ClassLoader；在之后的逆向过程中使用的ClassLoader都是这个ClassLoader。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">if(lpparam.packageName.startsWith(&quot;com.luhu.livexiuwu&quot;))&#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        //腾讯加固，需要获取对应classloader</span><br><span class="line">                        XposedHelpers.findAndHookMethod(&quot;com.tencent.StubShell.TxAppEntry&quot;, lpparam.classLoader,</span><br><span class="line">                                &quot;attachBaseContext&quot;, Context.class, new XC_MethodHook() &#123;</span><br><span class="line">                                    @Override</span><br><span class="line">                                    protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                                        super.afterHookedMethod(param);</span><br><span class="line">                                        //获取到Context对象，通过这个对象来获取classloader</span><br><span class="line">                                        Context context = (Context) param.args[0];</span><br><span class="line">                                        //获取classloader，之后hook加固后的就使用这个classloader</span><br><span class="line">                                        SecApp.hookLuhu(lpparam,context.getClassLoader());                                </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                &#125;);</span><br><span class="line">                    &#125;catch (Exception e)&#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h2 id="脱壳原理"><a href="#脱壳原理" class="headerlink" title="脱壳原理"></a>脱壳原理</h2><p>通过Hook ClassLoader的loadClass方法，反射调用getDex方法取得Dex(com.android.dex.Dex类对象)，在将里面的dex写出。<br>脱壳获取dex的关键代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">private static  void fDex(XC_LoadPackage.LoadPackageParam loadPackageParam2)&#123;</span><br><span class="line"></span><br><span class="line">        if(loadPackageParam2.packageName.equals(&quot;com.luhu.livexiuwu&quot;))&#123;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                Class Dex=Class.forName(&quot;com.android.dex.Dex&quot;);</span><br><span class="line">                Method Dex_getBytes=Dex.getDeclaredMethod(&quot;getBytes&quot;, new Class[0]);</span><br><span class="line">                Method getDex = Class.forName(&quot;java.lang.Class&quot;).getDeclaredMethod(&quot;getDex&quot;, new Class[0]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                XposedHelpers.findAndHookMethod(&quot;java.lang.ClassLoader&quot;, loadPackageParam2.classLoader, &quot;loadClass&quot;, String.class,boolean.class,new XC_MethodHook()&#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">                        Class cls = (Class) param.getResult();</span><br><span class="line">                     </span><br><span class="line"></span><br><span class="line">                        if (cls != null) &#123;</span><br><span class="line"></span><br><span class="line">                                try &#123;</span><br><span class="line">                                    byte[] bArr = (byte[]) Dex_getBytes.invoke(getDex.invoke(cls, new Object[0]), new Object[0]);</span><br><span class="line">                                   </span><br><span class="line"></span><br><span class="line">                                    if (bArr != null) &#123;</span><br><span class="line"></span><br><span class="line">                                        File apkFileDir = new File(CompatUtil.getSdcardSharedDir(), &quot;lulu&quot;);</span><br><span class="line"></span><br><span class="line">                                        if (!apkFileDir.exists()) &#123;</span><br><span class="line">                                            apkFileDir.mkdirs();</span><br><span class="line">                                        &#125;</span><br><span class="line"></span><br><span class="line">                                        String name = &quot;com.luhu.livexiuwu&quot;+bArr.length+&quot;.dex&quot;;</span><br><span class="line">                                        File file2 = new File(apkFileDir, name);</span><br><span class="line">                                       </span><br><span class="line">                                        if (!file2.exists()) &#123;</span><br><span class="line">                                            FileUtil.writeToFileBy(bArr, file2);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; catch (Exception e3) &#123;</span><br><span class="line">                                    </span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; catch (Throwable e) &#123;</span><br><span class="line">                XposedBridge.log(e);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://mp.weixin.qq.com/s/C44M4XNIlZ43iwI7dl95jw" target="_blank" rel="noopener">java and android 架构</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Xposed </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Xposed的配置与简单使用]]></title>
      <url>/2019/07/02/xposed/</url>
      <content type="html"><![CDATA[<h2 id="Xposed是什么"><a href="#Xposed是什么" class="headerlink" title="Xposed是什么"></a>Xposed是什么</h2><p>官方对此的解释是这样的：<br>“Xposed是一个适用于Android的框架。基于这个框架开发的模块可以改变系统和app应用的行为，而不需要修改APK。这是一个很棒的特性，意味着Xposed模块可以不经过任何修改，安装在各种不同的ROM上。Xposed模块可以很容易的开启和关闭。你只需要激活或者禁用Xposed模块，然后重启手机即可。”</p>
<a id="more"></a>
<h2 id="Hook是什么"><a href="#Hook是什么" class="headerlink" title="Hook是什么"></a>Hook是什么</h2><p>Hook 英文就是「挂钩」的意思.那我们如何使用这个「挂钩」呢？在我们的应用程序种，包括应用触发事件和后台逻辑处理，都是是根据事件流程一步步地向下执行。而「挂钩」的意思，就是在事件传送到终点前截获并监控事件的传输，像个钩子钩上事件一样，并且能够在钩上事件时，处理一些自己特定的事件。</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/02/xposed/hook.png" alt="hook" title class>
                <p>hook</p>
            </figure>
<p>如何理解，例如我们有一个方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private int getResult(int i, int i2) &#123;</span><br><span class="line">    return i+i2; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正常情况下，i=1，i2=1，我们能得到2，但是根据上图，现在我们知道利用Hook现在能做些什么了，通过Hook我们可以对参数i，i2进行修改，i=1，i2=2，最终我们得到的结果是3.这就是挂钩的作用。</p>
<p>关于Android中的Hook机制，大致有两个方式：</p>
<p>要 root 权限，直接Hook系统，可以干掉所有的App。</p>
<p>免root权限，但是只能 Hook 自身，对系统其它 App 无能为力。</p>
<h2 id="Xposed接入"><a href="#Xposed接入" class="headerlink" title="Xposed接入"></a>Xposed接入</h2><h3 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h3><p>这个工程就是我们的插件工程，也是我们需要激活的Xposed模块工程。在我们的群控项目中，我们的hotB就是我们的模块工程。什么是模块工程，可以理解我们使用Hook挂钩自定义消息体的工程。这个app安装后可以在Xposed app的模块中找到。</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/02/xposed/mokuai.png" alt="set" title class>
                <p>set</p>
            </figure>
<h3 id="导入api"><a href="#导入api" class="headerlink" title="导入api"></a>导入api</h3><p>倒入api比较简单：直接在build.gradle中添加依赖即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* Xposed */</span><br><span class="line">    provided &apos;de.robv.android.xposed:api:82&apos;</span><br><span class="line">    provided &apos;de.robv.android.xposed:api:82:sources&apos;</span><br></pre></td></tr></table></figure>

<p><strong>注意：这里是provided，因为Xposed里已有该jar包内容，再次打包进去会冲突，并导致handleLoadPackage没有回调</strong></p>
<h3 id="修改AndroidManifest-xml文件"><a href="#修改AndroidManifest-xml文件" class="headerlink" title="修改AndroidManifest.xml文件"></a>修改AndroidManifest.xml文件</h3><p>在标签里面加三个meta-data</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 作为xposed模块 --&gt;</span><br><span class="line">&lt;meta-data android:name=&quot;xposedmodule&quot; android:value=&quot;true&quot; /&gt;</span><br><span class="line">&lt;!-- Xposed的模块描述 显示在xposed模块列表那里第二行--&gt;</span><br><span class="line">&lt;meta-data android:name=&quot;xposeddescription&quot; android:value=&quot;HotAX&quot; /&gt;</span><br><span class="line">&lt;!-- XposedBridgeApi的最低版本号 --&gt;</span><br><span class="line">&lt;meta-data android:name=&quot;xposedminversion&quot; android:value=&quot;53&quot; /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="编写hook类"><a href="#编写hook类" class="headerlink" title="编写hook类"></a>编写hook类</h3><p>创建一个类，实现IXposedHookLoadPackage接口，重写handleLoadPackage方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class XposedModule implements IXposedHookLoadPackage &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void handleLoadPackage(final XC_LoadPackage.LoadPackageParam loadPackageParam) throws Throwable &#123;</span><br><span class="line">        if (!loadPackageParam.packageName.startsWith(&quot;com.hotax.autowechat&quot;)) &#123;</span><br><span class="line">            if (loadPackageParam.packageName.startsWith(&quot;com.tencent.mm&quot;)) &#123;</span><br><span class="line">                XposedHelpers.findAndHookMethod(Application.class, &quot;attach&quot;, Context.class, new XC_MethodHook() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建xposed-init文件"><a href="#创建xposed-init文件" class="headerlink" title="创建xposed_init文件"></a>创建xposed_init文件</h3><p>在main/assets目录下创建xposed_init文件，不要后缀名。这个就是模块的入口，只有一行代码，就是说明入口类,这个类就是我们上边的类，在这里我们能打印出所有package。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.hotax.autowechat.xposed.XposedModule。</span><br></pre></td></tr></table></figure>

<p>至此，Xposed模块开发的接入就全部完成了。</p>
<h2 id="Hook实现"><a href="#Hook实现" class="headerlink" title="Hook实现"></a>Hook实现</h2><h3 id="hook变量"><a href="#hook变量" class="headerlink" title="hook变量"></a>hook变量</h3><p>hook前</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private static  int staticPrivateInt = 100;</span><br><span class="line">public static  int staticPublicInt = 100;</span><br><span class="line">private static  String staticPrivateString = &quot;staticPrivateString&quot;;</span><br><span class="line">private static  String staticPublicString = &quot;staticPublicString&quot;;</span><br><span class="line"></span><br><span class="line">public  int publicInt = 200;</span><br><span class="line">private int privateInt = 300;</span><br><span class="line">private String privateString = &quot;privateString&quot;;</span><br><span class="line">private String publicString = &quot;publicString&quot;;</span><br></pre></td></tr></table></figure>

<p>hook</p>
<p>获取Class：</p>
<p>final Class&lt;?&gt; clazz = XposedHelpers.findClass(“全路径类名”, loadPackageParam.classLoader);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.setStaticIntField(clazz, &quot;staticPrivateInt&quot;, 99);</span><br><span class="line">XposedHelpers.setStaticIntField(clazz, &quot;staticPublicInt&quot;, 99);</span><br><span class="line">XposedHelpers.setStaticObjectField(clazz, &quot;staticPrivateString&quot;, &quot;hook_staticPrivateString&quot;);</span><br><span class="line">XposedHelpers.setStaticObjectField(clazz, &quot;staticPublicString&quot;, &quot;hook_staticPublicString&quot;);</span><br><span class="line"></span><br><span class="line">XposedHelpers.setStaticIntField(clazz, &quot;publicInt&quot;, 99);</span><br></pre></td></tr></table></figure>

<p>hook后结果打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">D/HookDemo: staticPrivateInt = 99</span><br><span class="line">D/HookDemo: staticPublicInt = 99</span><br><span class="line">D/HookDemo: staticPrivateString = hook_staticPrivateString</span><br><span class="line">D/HookDemo: staticPublicString = hook_staticPublicString</span><br><span class="line">D/HookDemo: publicInt = 200</span><br><span class="line">D/HookDemo: privateInt = 300</span><br><span class="line">D/HookDemo: privateString = privateString</span><br><span class="line">D/HookDemo: publicString = publicString</span><br></pre></td></tr></table></figure>

<p><strong>结论：XposedHelpers.setStaticObjectField方法只能修改静态变量，非静态变量不能使用此方式修改。否则会报java.lang.NullPointerException:异常；</strong>那非静态变量如何修改呢：例如我们目标程序里有两个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void publicMethod(String value)&#123;    </span><br><span class="line">   Log.d(Tag, &quot;参数打印-publicMethod：&quot; + value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void privateMethod(String value)&#123;</span><br><span class="line">   Log.d(Tag, &quot;参数打印-privateMethod：&quot; + value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hook非静态变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(clazz, &quot;publicFunc&quot;, String.class, new XC_MethodHook() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                   param.args[0] = &quot;before--------------publicMethod&quot;;</span><br><span class="line">                   XposedHelpers.setIntField(param.thisObject, &quot;publicInt&quot;, 199);</span><br><span class="line">                   XposedHelpers.setIntField(param.thisObject, &quot;privateInt&quot;, 199);</span><br><span class="line">                   XposedHelpers.setObjectField(param.thisObject, &quot;privateString&quot;, &quot;hook_privateString&quot;);</span><br><span class="line">                   XposedHelpers.setObjectField(param.thisObject, &quot;publicString&quot;, &quot;hook_publicString&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                   XposedHelpers.setIntField(param.thisObject, &quot;staticPrivateInt&quot;, 199);</span><br><span class="line">                   XposedHelpers.setIntField(param.thisObject, &quot;staticPublicInt&quot;, 199);</span><br><span class="line">                   XposedHelpers.setObjectField(param.thisObject, &quot;staticPrivateString&quot;, &quot;hook_-setObjectField-staticPrivateString&quot;);</span><br><span class="line">                   XposedHelpers.setObjectField(param.thisObject, &quot;staticPublicString&quot;, &quot;hook_-setObjectField-staticPublicString&quot;);</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>hook后结果打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">参数打印-publicMethod：before--------------publicMethod</span><br><span class="line">D/HookDemo: staticPrivateInt = 199</span><br><span class="line">D/HookDemo: staticPublicInt = 199</span><br><span class="line">D/HookDemo: staticPrivateString = hook_-setObjectField-staticPrivateString</span><br><span class="line">D/HookDemo: staticPublicString = hook_-setObjectField-staticPublicString</span><br><span class="line">D/HookDemo: publicInt = 199</span><br><span class="line">D/HookDemo: privateInt = 199</span><br><span class="line">D/HookDemo: privateString = hook_privateString</span><br><span class="line">D/HookDemo: publicString = hook_publicString</span><br></pre></td></tr></table></figure>

<p><strong>结论：非静态变量的修改只能通过反射某类中的某个方法（方法类型不限）中修改，且静态变量也可以这么修改。</strong></p>
<h3 id="hook方法"><a href="#hook方法" class="headerlink" title="hook方法"></a>hook方法</h3><h5 id="hook构造方法"><a href="#hook构造方法" class="headerlink" title="hook构造方法"></a>hook构造方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public HookDemo(String value)&#123;</span><br><span class="line">    Log.d(Tag, &quot;参数打印-带参构造方法：&quot; + value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">//Hook有参构造函数，修改参数</span><br><span class="line"> XposedHelpers.findAndHookConstructor(clazz, String.class,  new XC_MethodHook() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    param.args[0] = &quot;参数打印-带参构造方法：我是修改后的参数&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">                @Override</span><br><span class="line">                protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    XposedBridge.log(&quot;HOOK-After：&quot; +param.args[0]);</span><br><span class="line">                &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">D/HookDemo: 参数打印-带参构造方法：我是修改后的参数</span><br><span class="line">D/HookDemo: HOOK-After：参数打印-带参构造方法：我是修改后的参数</span><br></pre></td></tr></table></figure>

<h5 id="hook带返回值的方法"><a href="#hook带返回值的方法" class="headerlink" title="hook带返回值的方法"></a>hook带返回值的方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public String getHook(String value)&#123;</span><br><span class="line">   return value;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">1、</span><br><span class="line">XposedHelpers.findAndHookMethod(clazz, &quot;getHook&quot;, String.class, new XC_MethodHook() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    param.args[0] = &quot;返回值：before--------------gethook&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">执行结果：</span><br><span class="line">D/HookDemo: getHook 返回值 = 返回值：before--------------gethook</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">2、</span><br><span class="line">   XposedHelpers.findAndHookMethod(clazz, &quot;getHook&quot;, String.class, new XC_MethodHook() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">//                    param.args[0] = &quot;返回值：before--------------gethook&quot;;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    param.setResult(&quot;返回值：after--------------gethook&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"> 执行结果：</span><br><span class="line">D/HookDemo: getHook 返回值 = 返回值：after--------------gethook</span><br></pre></td></tr></table></figure>

<h5 id="hook静态方法"><a href="#hook静态方法" class="headerlink" title="hook静态方法"></a>hook静态方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">private static String staticPrivateMethod(String value)&#123;</span><br><span class="line">    Log.d(&quot;HookDemo&quot;, &quot;静态函数--&quot; + value);</span><br><span class="line">    return &quot;静态函数--返回：&quot;+value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">1、</span><br><span class="line">XposedHelpers.findAndHookMethod(clazz, &quot;staticPrivateMethod&quot;, String.class, new XC_MethodHook() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    param.args[0] = &quot;before---&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    </span><br><span class="line">执行结果：</span><br><span class="line">D/HookDemo: 静态函数--before---</span><br><span class="line">D/HookDemo: 静态函数--返回：before---</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">2、</span><br><span class="line">XposedHelpers.findAndHookMethod(clazz, &quot;staticPrivateMethod&quot;, String.class, new XC_MethodHook() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    param.args[0] = &quot;before---&quot;;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    param.setResult(&quot;静态函数--返回：after---&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">执行结果：</span><br><span class="line">D/HookDemo: 静态函数--before---</span><br><span class="line">D/HookDemo: 静态函数--返回：after---</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">3、</span><br><span class="line">Object object = XposedHelpers.callStaticMethod(clazz, &quot;staticPrivateMethod&quot;, &quot;callStaticMethod 静态函数调用&quot;);</span><br><span class="line">Log.d(&quot;HookDemo&quot;, &quot;xposed-:staticPrivateFunc:&quot;+object);</span><br><span class="line"></span><br><span class="line">执行结果：</span><br><span class="line">D/HookDemo: 静态函数--callStaticMethod 静态函数调用</span><br><span class="line">D/HookDemo: xposed-:staticPrivateFunc:静态函数--返回：callStaticMethod 静态函数调用</span><br></pre></td></tr></table></figure>

<p><strong>结论：静态方法的修改和其他方法hook方式一样，但是静态方法可以直接通过callStaticMethod进行参数的修改。</strong></p>
<h5 id="Hook复杂的参数"><a href="#Hook复杂的参数" class="headerlink" title="Hook复杂的参数"></a>Hook复杂的参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void paramsClass(ClasName cn, String value,Intent intent,int key,Map map,List list)&#123;  </span><br><span class="line">&#125;</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Class cnClazz  = loadPackageParam.classLoader.loadClass(&quot;com.xxxx. ClasName&quot;);</span><br><span class="line">Class cnMap = XposedHelpers.findClass(&quot;java.util.Map&quot;, loadPackageParam.classLoader);</span><br><span class="line">Class cnArrayList = XposedHelpers.findClass(&quot;java.util.ArrayList&quot;, loadPackageParam.classLoader);</span><br><span class="line"></span><br><span class="line">XposedHelpers.findAndHookMethod(clazz, &quot;paramsClass&quot;, cnClazz, String.class, Intent.class,int.class,Map.class,ArrayList.class new XC_MethodHook() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="Hook内部类中的函数"><a href="#Hook内部类中的函数" class="headerlink" title="Hook内部类中的函数"></a>Hook内部类中的函数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class HookDemo &#123;</span><br><span class="line">    private String Tag = &quot;HookDemo&quot;;</span><br><span class="line">    class InnerClass&#123;</span><br><span class="line">        public int innerPublicInt = 10;</span><br><span class="line">        private int innerPrivateInt = 20;</span><br><span class="line">        public InnerClass()&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        public void InnerFunc(String value)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">final Class&lt;?&gt; clazz1 = XposedHelpers.findClass(&quot;com.xxxxxx.HookDemo$InnerClass&quot;, loadPackageParam.classLoader);</span><br><span class="line">XposedHelpers.findAndHookMethod(clazz1, &quot;InnerMethod&quot;, String.class, new XC_MethodHook() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>注：hook内部类中的函数和变量，跟以上的hook方式没有区别，唯一的区别是，XposedHelpers.findClass中的路径名不同。</strong></p>
<h5 id="Hook匿名内部类中的函数"><a href="#Hook匿名内部类中的函数" class="headerlink" title="Hook匿名内部类中的函数"></a>Hook匿名内部类中的函数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">anonymousInner(new ClasName() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void clasNameMethod(String value) &#123;</span><br><span class="line">        		Log.d(Tag, &quot;匿名类参数修改：get：&quot; + value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">XposedHelpers.findAndHookMethod(&quot;com.xxxxxx.HookDemo$1&quot;, clazz.getClassLoader(),</span><br><span class="line">                    &quot;clasNameMethod&quot;,String.class, new XC_MethodHook() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                             param.args[0] = &quot;匿名类-参数修改&quot;;                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">执行结果：</span><br><span class="line">D/HookDemo: 匿名类参数修改：get：匿名类-参数修改</span><br></pre></td></tr></table></figure>

<h5 id="Hook替换函数"><a href="#Hook替换函数" class="headerlink" title="Hook替换函数"></a>Hook替换函数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private void repleaceMethod()&#123;</span><br><span class="line">    getHook(&quot;sfdsfs-afsafsf&quot;);</span><br><span class="line">&#125;</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"> XposedHelpers.findAndHookMethod(clazz, &quot;repleaceMethod&quot;, new XC_MethodReplacement() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected Object replaceHookedMethod(MethodHookParam methodHookParam) throws Throwable &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">	            			// 直接替换原来要执行的逻辑代码,目标方法就不在执行了</span><br><span class="line">			        &#125; catch (Throwable t) &#123;</span><br><span class="line">			            XposedBridge.log(t);</span><br><span class="line">			        &#125;                    </span><br><span class="line">		       </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="替换资源"><a href="#替换资源" class="headerlink" title="替换资源"></a>替换资源</h3><h4 id="IXposedHookZygoteInit"><a href="#IXposedHookZygoteInit" class="headerlink" title="IXposedHookZygoteInit"></a>IXposedHookZygoteInit</h4><p>Hook the initialization of Zygote process(es), from which all the apps are forked.</p>
<p>Implement this interface in your module’s main class in order to be notified when Android is starting up. In IXposedHookZygoteInit, you can modify objects and place hooks that should be applied for every app. Only the Android framework/system classes are available at that point in time. Use null as class loader for XposedHelpers.findAndHookMethod(String, ClassLoader, String, Object…) and its variants.</p>
<p>If you want to hook one/multiple specific apps, use IXposedHookLoadPackage instead.</p>
<p>替换系统框架资源（对所有app 起作用）需要实现 IXposedHookZygoteInit接口的 initZygote 方法，并在该方法中调用Resources.setSystemWideReplacement(…) 方法替换资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class Tutorial2  implements IXposedHookZygoteInit&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void initZygote(StartupParam arg0) throws Throwable &#123;</span><br><span class="line">        XResources.setSystemWideReplacement(&quot;android&quot;, &quot;bool&quot;, &quot;config_unplugTurnsOnScreen&quot;, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="IXposedHookInitPackageResources"><a href="#IXposedHookInitPackageResources" class="headerlink" title="IXposedHookInitPackageResources"></a>IXposedHookInitPackageResources</h4><p>替换app应用资源需要实现 IXposedHookInitPackageResources 类的<br>andleInitPackageResources方法，并在该方法中调用res.setReplacement(…)方法替换资源，注意在该方法中不要使用XResources.setSystemWideReplacement 方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> public void handleInitPackageResources(XC_InitPackageResources.InitPackageResourcesParam resparam) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">     if (resparam.packageName.equals(&quot;com.example.xposedhooktarget&quot;)) &#123;</span><br><span class="line">         //getClassInfo(clazz);</span><br><span class="line">         resparam.res.setReplacement(&quot;com.xxxxxx.xposedhooktarget&quot;, &quot;string&quot;, &quot;action_test&quot;, &quot;HkTargetTest&quot;);</span><br><span class="line">         resparam.res.setReplacement(&quot;com.example.xposedhooktarget&quot;, &quot;color&quot;, &quot;colorAccent&quot;, R.color.colorPrimary);</span><br><span class="line">resparam.res.setReplacement(&quot;2131165219&quot;, &quot;HkTargetTest-action_text&quot;);</span><br><span class="line">         resparam.res.setReplacement(&quot;com.xxxxxxx.xposedhooktarget&quot;, &quot;mipmap&quot;, &quot;test_icon&quot;, new XResources.DrawableLoader() &#123;</span><br><span class="line">             @Override</span><br><span class="line">             public Drawable newDrawable(XResources res, int id) throws Throwable &#123;</span><br><span class="line">                 Drawable dg = res.getDrawable(R.mipmap.ic_launcher);</span><br><span class="line">                 return dg;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>还可以替换动画文件等等。</p>
<h3 id="修改布局"><a href="#修改布局" class="headerlink" title="修改布局"></a>修改布局</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">resparam.res.hookLayout(&quot;com.xxxxxx.xposedhooktarget&quot;, &quot;layout&quot;, &quot;activity_main&quot;, new XC_LayoutInflated() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               public void handleLayoutInflated(LayoutInflatedParam liparam) throws Throwable &#123;</span><br><span class="line">                   //增加一个TextView</span><br><span class="line">                   FrameLayout contentview = (FrameLayout) liparam.view;</span><br><span class="line">                   if (contentview != null) &#123;</span><br><span class="line">                       TextView textView = new TextView(contentview.getContext());</span><br><span class="line">                       textView.setText(&quot;修改布局&quot;);</span><br><span class="line">                       contentview.addView(textView);</span><br><span class="line">                   &#125;</span><br><span class="line">                   //修改@+id= bt_text1 的TextView的文案</span><br><span class="line">                   TextView bt_text1 = (TextView) liparam.view.findViewById(</span><br><span class="line">                           liparam.res.getIdentifier(&quot;bt_text1&quot;, &quot;id&quot;, &quot;com.xxxxxx.xposedhooktarget&quot;));</span><br><span class="line">                   bt_text1.setText(&quot;修改布局文本&quot;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="群控"><a href="#群控" class="headerlink" title="群控"></a>群控</h2><p>需求：被动添加好友。</p>
<p>要求：采用静默的无感知模式。</p>
<p>实现：思路，采用hook添加好友协议的模式，入口在db的hook基础上进行监听验证好友的请求，因为不论什么信息，都会首先会存储与微信的db中。</p>
<p>前提：已经hook了界面的跳转，和打开了微信的log信息。<a href="http://wxc.58corp.com/pages/viewpage.action?pageId=25070673" target="_blank" rel="noopener">详细点击</a>.</p>
<p>过程：在前提下，我们可以得到了三个关于被动添加好友的信息：</p>
<p>1、好友通过验证的界面名称和传递的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">E/hotWeixinHook: ActivityHook; activity=com.tencent.mm.plugin.profile.ui.SayHiWithSnsPermissionUI@a3b6b62, onCreate; getIntent()=Intent</span><br><span class="line">        &#123; cmp=com.tencent.mm/.plugin.profile.ui.SayHiWithSnsPermissionUI (has extras), extra=bundle&#123;</span><br><span class="line">            sayhi_with_sns_perm_send_verify=true,</span><br><span class="line">        room_name=null,</span><br><span class="line">        source_from_user_name=null,</span><br><span class="line">        sayhi_with_sns_perm_add_remark=true,</span><br><span class="line">        source_from_nick_name=null,</span><br><span class="line">        Contact_Nick=大王,</span><br><span class="line">        Contact_User=v1_841761d9ad2fee00bafee3e6c65ec45aef0c541d5c3bacfc2d24acd30fe184f31cd28a41808180cfff4ebd0325d4a1a1@stranger,</span><br><span class="line">        Contact_Scene=15,</span><br><span class="line">        Contact_RemarkName=,</span><br><span class="line">        =false,</span><br><span class="line">        AntispamTicket=v2_6e521f51ae39720c3154a79ba26c689efab115f39b314795f803a2889d76a013e05b3569cdd1f5328da35803ed134968@stranger</span><br><span class="line"></span><br><span class="line">        &#125; &#125;, bundle=bundle&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>2、验证的详细信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MicroMsg.FMessageProvider; setDigest, </span><br><span class="line">fmsgType = 1, fmsgScene = 30, </span><br><span class="line">fmsgContent = </span><br><span class="line">&lt;msg </span><br><span class="line">fromusername=&quot;aibhyi1314521&quot; encryptusername=&quot;v1_4bb4022da882fa9b480543b3a0e48fcc76b5530d371c9defe34a653497843e38@stranger&quot; </span><br><span class="line">fromnickname=&quot;忘记一切&quot; </span><br><span class="line">content=&quot;我是忘记一切&quot; </span><br><span class="line">fullpy=&quot;wangjiyiqie&quot; </span><br><span class="line">shortpy=&quot;WJYQ&quot; </span><br><span class="line">imagestatus=&quot;3&quot; </span><br><span class="line">scene=&quot;30&quot; country=&quot;CN&quot; province=&quot;Hebei&quot; city=&quot;Baoding&quot; </span><br><span class="line">sign=&quot;带走一盏渔火，让他温暖我的双眼。留下一段真情让他停泊在枫桥边&quot; percard=&quot;1&quot; sex=&quot;1&quot; alias=&quot;wuluqi0606&quot; weibo=&quot;&quot; albumflag=&quot;0&quot; albumstyle=&quot;0&quot; albumbgimgid=&quot;&quot; snsflag=&quot;17&quot; </span><br><span class="line">snsbgimgid=&quot;http://shmmsns.qpic.cn/mmsns/CttmTaYSYkS6fvUyDJs0icQ6oRUqibtDIuUylCkHeRHfk4jF7nToTbSYAm5H0z84qh9fHACkovW1c/0&quot; </span><br><span class="line">snsbgobjectid=&quot;12854304281324228767&quot; mhash=&quot;3140af8c3cd25f8db0eaa8815cc2cd95&quot; mfullhash=&quot;3140af8c3cd25f8db0eaa8815cc2cd95&quot; </span><br><span class="line">bigheadimgurl=&quot;http://wx.qlogo.cn/mmhead/ver_1/qKwkYHXZa7iahrsJ2DV7NhuZnrWft9icLTiculKSTJiaJVQvpMPV1dyKH9HuqM3F9picnfZ6dd1ujxxCADH0tHburXhYQBsSP0ZQbD8USaqzXh7c/0&quot; smallheadimgurl=&quot;http://wx.qlogo.cn/mmhead/ver_1/qKwkYHXZa7iahrsJ2DV7NhuZnrWft9icLTiculKSTJiaJVQvpMPV1dyKH9HuqM3F9picnfZ6dd1ujxxCADH0tHburXhYQBsSP0ZQbD8USaqzXh7c/96&quot; ticket=&quot;v2_e57f9519b15cab7743fe81feced778340c7cb4a2c6cbbb361fdd606bbf815478db4e967568ece4fbf27519726dda64492f68992a4e750ef8e4e6e72724f075e8@stranger&quot; </span><br><span class="line">opcode=&quot;2&quot; googlecontact=&quot;&quot; qrticket=&quot;&quot; chatroomusername=&quot;&quot; sourceusername=&quot;&quot; sourcenickname=&quot;&quot;&gt;</span><br><span class="line">&lt;brandlist count=&quot;0&quot; ver=&quot;685330891&quot;&gt;&lt;/brandlist&gt;</span><br><span class="line">&lt;/msg&gt;, </span><br><span class="line">isSend = false</span><br></pre></td></tr></table></figure>

<p>3、存储数据库名称。</p>
<p>MicroMsg.SDK.MAutoStorage; <strong>fmessage_conversation</strong>:get with primary key</p>
<p>4、根据1得到的界面，我们可以查看微信的逆向代码。我是用的jadx-0.7.2，不要用jadx低版本，因为低版本的逆向结果的代码中，不含有我们需要hook的具体类名和方法名。因为微信的包比较大，我们最好把逆向代码导出来，使用的时候用AS打开即可。</p>
<p>5、<br>我们看下点击发送按钮等源代码：（比较长，但是不贴一下，没法说啊）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">class C305316 implements OnMenuItemClickListener &#123;</span><br><span class="line">        C305316() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public final boolean onMenuItemClick(MenuItem menuItem) &#123;</span><br><span class="line">            final C1138k c8233f;</span><br><span class="line">            SayHiWithSnsPermissionUI sayHiWithSnsPermissionUI;</span><br><span class="line">            Context context;</span><br><span class="line">            if (SayHiWithSnsPermissionUI.this.f97358pqM) &#123;</span><br><span class="line">                int i;</span><br><span class="line">                List linkedList = new LinkedList();</span><br><span class="line">                linkedList.add(SayHiWithSnsPermissionUI.this.userName);</span><br><span class="line">                List linkedList2 = new LinkedList();</span><br><span class="line">                linkedList2.add(Integer.valueOf(SayHiWithSnsPermissionUI.this.f97352pnn));</span><br><span class="line">                String g = SayHiWithSnsPermissionUI.m63520g(SayHiWithSnsPermissionUI.this);</span><br><span class="line">                Map hashMap = new HashMap();</span><br><span class="line">                if (SayHiWithSnsPermissionUI.this.f97357pqL.f28645zEk) &#123;</span><br><span class="line">                    i = 1;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    i = 0;</span><br><span class="line">                &#125;</span><br><span class="line">                hashMap.put(SayHiWithSnsPermissionUI.this.userName, Integer.valueOf(i));</span><br><span class="line">                C6159x.m11666d(&quot;MicroMsg.SayHiWithSnsPermissionUI&quot;, &quot;select sns permission, %s&quot;, Integer.valueOf(i));</span><br><span class="line">                if (C10044x.m20844Xg(SayHiWithSnsPermissionUI.this.userName)) &#123;</span><br><span class="line">                    c8233f = new C8233f(SayHiWithSnsPermissionUI.this.userName, g, SayHiWithSnsPermissionUI.this.getIntent().getStringExtra(C32536a.f104548xML));</span><br><span class="line">                    C32688as.m69428CN().mo13442a(c8233f, 0);</span><br><span class="line">                    sayHiWithSnsPermissionUI = SayHiWithSnsPermissionUI.this;</span><br><span class="line">                    context = SayHiWithSnsPermissionUI.this.mController.f28409xRr;</span><br><span class="line">                    SayHiWithSnsPermissionUI.this.getString(C1085R.C1081l.f8616dGZ);</span><br><span class="line">                    sayHiWithSnsPermissionUI.f97348inI = C36199h.m82220a(context, SayHiWithSnsPermissionUI.this.getString(C1085R.C1081l.f10212eKs), true, new OnCancelListener() &#123;</span><br><span class="line">                        public final void onCancel(DialogInterface dialogInterface) &#123;</span><br><span class="line">                            C32688as.m69428CN().mo13446c(c8233f);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    final C1138k c31589o = new C31589o(2, linkedList, linkedList2, g, &quot;&quot;, hashMap, SayHiWithSnsPermissionUI.this.chatroomName);</span><br><span class="line">                    String stringExtra = SayHiWithSnsPermissionUI.this.getIntent().getStringExtra(&quot;source_from_user_name&quot;);</span><br><span class="line">                    String stringExtra2 = SayHiWithSnsPermissionUI.this.getIntent().getStringExtra(&quot;source_from_nick_name&quot;);</span><br><span class="line">                    if (!C6135bi.m11498oN(stringExtra)) &#123;</span><br><span class="line">                        c31589o.mo40569fj(stringExtra, stringExtra2);</span><br><span class="line">                    &#125;</span><br><span class="line">                    C32688as.m69428CN().mo13442a(c31589o, 0);</span><br><span class="line">                    SayHiWithSnsPermissionUI sayHiWithSnsPermissionUI2 = SayHiWithSnsPermissionUI.this;</span><br><span class="line">                    context = SayHiWithSnsPermissionUI.this.mController.f28409xRr;</span><br><span class="line">                    SayHiWithSnsPermissionUI.this.getString(C1085R.C1081l.f8616dGZ);</span><br><span class="line">                    sayHiWithSnsPermissionUI2.f97348inI = C36199h.m82220a(context, SayHiWithSnsPermissionUI.this.getString(C1085R.C1081l.f10212eKs), true, new OnCancelListener() &#123;</span><br><span class="line">                        public final void onCancel(DialogInterface dialogInterface) &#123;</span><br><span class="line">                            C32688as.m69428CN().mo13446c(c31589o);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (SayHiWithSnsPermissionUI.this.f97359pqN) &#123;</span><br><span class="line">                String stringExtra3 = SayHiWithSnsPermissionUI.this.getIntent().getStringExtra(&quot;Verify_ticket&quot;);</span><br><span class="line">                if (C10044x.m20844Xg(SayHiWithSnsPermissionUI.this.userName)) &#123;</span><br><span class="line">                    c8233f = new C8234g(SayHiWithSnsPermissionUI.this.userName, stringExtra3);</span><br><span class="line">                    C32688as.m69428CN().mo13442a(c8233f, 0);</span><br><span class="line">                    sayHiWithSnsPermissionUI = SayHiWithSnsPermissionUI.this;</span><br><span class="line">                    context = SayHiWithSnsPermissionUI.this.mController.f28409xRr;</span><br><span class="line">                    SayHiWithSnsPermissionUI.this.getString(C1085R.C1081l.f8616dGZ);</span><br><span class="line">                    sayHiWithSnsPermissionUI.f97348inI = C36199h.m82220a(context, SayHiWithSnsPermissionUI.this.getString(C1085R.C1081l.f9343dUY), true, new OnCancelListener() &#123;</span><br><span class="line">                        public final void onCancel(DialogInterface dialogInterface) &#123;</span><br><span class="line">                            C32688as.m69428CN().mo13446c(c8233f);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    c8233f = new C31589o(SayHiWithSnsPermissionUI.this.userName, stringExtra3, SayHiWithSnsPermissionUI.this.f97352pnn);</span><br><span class="line">                    C32688as.m69428CN().mo13442a(c8233f, 0);</span><br><span class="line">                    sayHiWithSnsPermissionUI = SayHiWithSnsPermissionUI.this;</span><br><span class="line">                    context = SayHiWithSnsPermissionUI.this.mController.f28409xRr;</span><br><span class="line">                    SayHiWithSnsPermissionUI.this.getString(C1085R.C1081l.f8616dGZ);</span><br><span class="line">                    sayHiWithSnsPermissionUI.f97348inI = C36199h.m82220a(context, SayHiWithSnsPermissionUI.this.getString(C1085R.C1081l.f9343dUY), true, new OnCancelListener() &#123;</span><br><span class="line">                        public final void onCancel(DialogInterface dialogInterface) &#123;</span><br><span class="line">                            C32688as.m69428CN().mo13446c(c8233f);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>经过一系列判断，我们最终最后定位到通过协议的代码C32688as.m69428CN().mo13442a(c8233f, 0);为啥啊，因为不管是if和else if的的条件我们都能够拿到，怎么拿到，我们可以通过XposedHelpers.getObjectField(param.thisObject, “方法变量”);获得到f97359pqN和f97358pqM的值；然后我们看C32688as这个类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/* renamed from: com.tencent.mm.y.as */</span><br><span class="line">public final class C32688as &#123;</span><br><span class="line">	/* renamed from: CN */</span><br><span class="line">    public static C7656n m69428CN() &#123;</span><br><span class="line">        C1693g.m4270Dr();</span><br><span class="line">        return C1693g.m4268Dp().f13865gRu;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看C7656n调用类：好吧只看mo13442a这一个方法就行了，这个就是通过好友的开始方法了；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/* renamed from: com.tencent.mm.ad.n */</span><br><span class="line">public final class C7656n implements C1125e &#123;</span><br><span class="line">	/* renamed from: a */</span><br><span class="line">    public final boolean mo13442a(C1138k c1138k, int i) &#123;</span><br><span class="line">        boolean z = c1138k != null || i &gt;= 0;</span><br><span class="line">        Assert.assertTrue(z);</span><br><span class="line">        String str = &quot;worker thread has not been set&quot;;</span><br><span class="line">        if (this.f30978hoG != null) &#123;</span><br><span class="line">            z = true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            z = false;</span><br><span class="line">        &#125;</span><br><span class="line">        Assert.assertTrue(str, z);</span><br><span class="line">        if (!m15236e(c1138k)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        m15231b(c1138k, i);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在看请求的参数：一个类C31589o，好吧，看出来了，就是一个model类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* renamed from: com.tencent.mm.pluginsdk.model.o */</span><br><span class="line">public class C31589o extends C1138k implements C1865k &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上：我们可以得到最终的静默实现好友验证请求通过了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void onUpdate(Object database, String path, String table, ContentValues values, String whereClause, String[] whereArgs, int conflictAlgorithm) &#123;</span><br><span class="line">        if (DBConstants.MicroMsg.Fmessage_Conversation.TABLE_NAME.equals(table)) &#123;</span><br><span class="line"></span><br><span class="line">            Integer isNew = values.getAsInteger(DBConstants.MicroMsg.Fmessage_Conversation.COLUMN_isNew);</span><br><span class="line">            String talker = values.getAsString(DBConstants.MicroMsg.Fmessage_Conversation.COLUMN_talker);</span><br><span class="line">            Log.e(WeixinHook.TAG, &quot;DBEventReceiveFriendsVerify; parseRequestContent;isNew.&quot;+isNew);</span><br><span class="line"></span><br><span class="line">            // isNew == 1:新好友请求</span><br><span class="line">            if (isNew != null &amp;&amp; isNew == 1) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    String fmsgContent = values.getAsString(DBConstants.MicroMsg.Fmessage_Conversation.COLUMN_fmsgContent);</span><br><span class="line">                    Log.e(WeixinHook.TAG, &quot;DBEventReceiveFriendsVerify; parseRequestContent;fmsgContent.&quot;+fmsgContent);</span><br><span class="line"></span><br><span class="line">                    JSONObject jsonObject = new XmlToJson.Builder(fmsgContent).build().toJson();</span><br><span class="line">                    JSONObject appMsg = jsonObject.getJSONObject(&quot;msg&quot;);</span><br><span class="line">                    if (fmsgContent == null) &#123;</span><br><span class="line">                        Log.e(WeixinHook.TAG, &quot;DBEventReceiveFriendsVerify; parseRequestContent; appMsg is null, just return.&quot;);</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Log.e(WeixinHook.TAG, &quot;DBEventReceiveFriendsVerify; &amp;wxid:=&quot; + appMsg.getString(&quot;fromusername&quot;) + &quot;&amp;ticket:&quot; + appMsg.getString(&quot;ticket&quot;) + &quot;&amp;scene:&quot; + appMsg.getInt(&quot;scene&quot;));</span><br><span class="line">                    int state  = Utils.getFCState(talker);</span><br><span class="line">                    Log.e(WeixinHook.TAG, &quot;DBEventReceiveFriendsVerify; state1:&quot;+state);</span><br><span class="line">                    if(state == 1)&#123;</span><br><span class="line">                        report(appMsg.getString(&quot;fromusername&quot;).toString(),</span><br><span class="line">                                appMsg.getString(&quot;fromnickname&quot;).toString(),</span><br><span class="line">                                appMsg.getString(&quot;content&quot;).toString()</span><br><span class="line">                        );</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line">                        final Object instance_y_as_cn = XposedHelpers.callStaticMethod(</span><br><span class="line">                                XposedHelpers.findClass(&quot;com.tencent.mm.y.as&quot;, mWeixinHook.getClassLoader()),</span><br><span class="line">                                &quot;CN&quot;</span><br><span class="line">                        );</span><br><span class="line"></span><br><span class="line">                        String username = appMsg.getString(&quot;fromusername&quot;).toString();</span><br><span class="line">                        String ticket = appMsg.getString(&quot;ticket&quot;).toString();</span><br><span class="line">                        int scene = appMsg.getInt(&quot;scene&quot;);</span><br><span class="line">                        Class&lt;?&gt; class_model_o = XposedHelpers.findClass(&quot;com.tencent.mm.pluginsdk.model.o&quot;, mWeixinHook.getClassLoader());</span><br><span class="line">                        Object request = XposedHelpers.newInstance(class_model_o, username, ticket, scene);</span><br><span class="line"></span><br><span class="line">                        Object result = XposedHelpers.callMethod(instance_y_as_cn, &quot;a&quot;, request, 0);</span><br><span class="line">                        Log.e(WeixinHook.TAG, &quot;DBEventReceiveFriendsVerify; result; &quot; + result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>测试一下，搞定。</p>
<h2 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h2><p><a href="https://api.xposed.info/reference/packages.html" target="_blank" rel="noopener">https://api.xposed.info/reference/packages.html</a></p>
<p><a href="https://bintray.com/rovo89/de.robv.android.xposed/api" target="_blank" rel="noopener">https://bintray.com/rovo89/de.robv.android.xposed/api</a></p>
<p><a href="http://www.infoq.com/cn/articles/android-in-depth-xposed" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/android-in-depth-xposed</a></p>
<p><a href="https://blog.csdn.net/u012417380/article/details/55254369?locationNum=13&amp;fps=1" target="_blank" rel="noopener">https://blog.csdn.net/u012417380/article/details/55254369?locationNum=13&amp;fps=1</a></p>
<p><a href="https://www.cnblogs.com/gordon0918/p/6732100.html" target="_blank" rel="noopener">https://www.cnblogs.com/gordon0918/p/6732100.html</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Xposed </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MIUI权限检测之路]]></title>
      <url>/2019/07/02/permissioncheck/</url>
      <content type="html"><![CDATA[<h2 id="问题与需求"><a href="#问题与需求" class="headerlink" title="问题与需求"></a>问题与需求</h2><p>在业务线在使用过程中，发生了一些权限状态丢失的情况。而在我们的群控平台中，如果某些权限的设置状态丢失，则群控平台绝大多数功能不能执行。尤其是HRG业务人员，它们不仅需要群控自动执行功能指令，还不能影响手动操作。所以在权限状态丢失后，产品提出了一个权限检测的需求。这个需求就是在我们的平台中检测应用的权限列表，获取权限的当前状态。用于提示使用者，当前的群控在权限设置上是否已经被允许。</p>
<a id="more"></a>
<h2 id="权限介绍"><a href="#权限介绍" class="headerlink" title="权限介绍"></a>权限介绍</h2><p>一个Android应用默认情况下是不拥有任何权限的,  在默认情况下, 一个应用是没有权利去进行一些可能会造成不好影响的操作的. 这些不好的影响可能是对其它应用,操作系统,或者是用户.<br>如果应用需要某些额外的能力,则需要在AndroidManifest.xml中静态地声明相应的权限.<br>也就是我们在AndroidManifest.xml注册了一系列uses-permission，这些permission就是我们需要申请的权限。</p>
<p>在Android 6.0发布之前, 所有的权限都在安装应用的时候显示给用户,用户选择安装则表示全部接受这些权限, 之后无法撤销对这些权限的授权.<br>但是从Android 6.0开始, 一部分比较危险的权限需要在程序运行请求用户授权.<br>至于什么时候需要授权,由应用程序自己决定.而这些权限，就是我们所说的运行时权限。<br>而对于其他权限,认为不是很危险,所以仍然保持原来的做法,在用户安装应用程序时就予以授权.<br>需要注意的是,在设置中,对于应用的危险权限,用户可以选择性地进行授权或者关闭.</p>
<p>Dangerous Permissions主要有：</p>
<table style="margin-left: auto; margin-right: auto;">
<tbody>
<tr><th>Permission Group</th><th>Permissions</th></tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#CALENDAR" target="_blank" rel="noopener">CALENDAR</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#READ_CALENDAR" target="_blank" rel="noopener">READ_CALENDAR</a></code></li>
</ul>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#WRITE_CALENDAR" target="_blank" rel="noopener">WRITE_CALENDAR</a></code></li>
</ul>
</td>
</tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#CAMERA" target="_blank" rel="noopener">CAMERA</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#CAMERA" target="_blank" rel="noopener">CAMERA</a></code></li>
</ul>
</td>
</tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#CONTACTS" target="_blank" rel="noopener">CONTACTS</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#READ_CONTACTS" target="_blank" rel="noopener">READ_CONTACTS</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#WRITE_CONTACTS" target="_blank" rel="noopener">WRITE_CONTACTS</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#GET_ACCOUNTS" target="_blank" rel="noopener">GET_ACCOUNTS</a></code></li>
</ul>
</td>
</tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#LOCATION" target="_blank" rel="noopener">LOCATION</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#ACCESS_FINE_LOCATION" target="_blank" rel="noopener">ACCESS_FINE_LOCATION</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#ACCESS_COARSE_LOCATION" target="_blank" rel="noopener">ACCESS_COARSE_LOCATION</a></code></li>
</ul>
</td>
</tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#MICROPHONE" target="_blank" rel="noopener">MICROPHONE</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#RECORD_AUDIO" target="_blank" rel="noopener">RECORD_AUDIO</a></code></li>
</ul>
</td>
</tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#PHONE" target="_blank" rel="noopener">PHONE</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#READ_PHONE_STATE" target="_blank" rel="noopener">READ_PHONE_STATE</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#CALL_PHONE" target="_blank" rel="noopener">CALL_PHONE</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#READ_CALL_LOG" target="_blank" rel="noopener">READ_CALL_LOG</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#WRITE_CALL_LOG" target="_blank" rel="noopener">WRITE_CALL_LOG</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#ADD_VOICEMAIL" target="_blank" rel="noopener">ADD_VOICEMAIL</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#USE_SIP" target="_blank" rel="noopener">USE_SIP</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#PROCESS_OUTGOING_CALLS" target="_blank" rel="noopener">PROCESS_OUTGOING_CALLS</a></code></li>
</ul>
</td>
</tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#SENSORS" target="_blank" rel="noopener">SENSORS</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#BODY_SENSORS" target="_blank" rel="noopener">BODY_SENSORS</a></code></li>
</ul>
</td>
</tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#SMS" target="_blank" rel="noopener">SMS</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#SEND_SMS" target="_blank" rel="noopener">SEND_SMS</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#RECEIVE_SMS" target="_blank" rel="noopener">RECEIVE_SMS</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#READ_SMS" target="_blank" rel="noopener">READ_SMS</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#RECEIVE_WAP_PUSH" target="_blank" rel="noopener">RECEIVE_WAP_PUSH</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#RECEIVE_MMS" target="_blank" rel="noopener">RECEIVE_MMS</a></code></li>
</ul>
</td>
</tr>
<tr>
<td><code><a href="https://developer.android.com/reference/android/Manifest.permission_group.html#STORAGE" target="_blank" rel="noopener">STORAGE</a></code></td>
<td>
<ul>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#READ_EXTERNAL_STORAGE" target="_blank" rel="noopener">READ_EXTERNAL_STORAGE</a></code></li>
<li><code><a href="https://developer.android.com/reference/android/Manifest.permission.html#WRITE_EXTERNAL_STORAGE" target="_blank" rel="noopener">WRITE_EXTERNAL_STORAGE</a></code></li>
</ul>
</td>
</tr>
</tbody>
</table>        

<p>而通过上述危险权限来看，是有了组的概念，只要我们授权了其中一个权限，那就授权当前组的所有全新啊。而我们可以通过下面的方法获取到所有的申请权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PackageManager packageManager = this.getPackageManager();</span><br><span class="line">PackageInfo packageInfo =packageManager.getPackageInfo(packageName, PackageManager.GET_PERMISSIONS);</span><br><span class="line">String[] usesPermissionsArray = packageInfo.requestedPermissions;</span><br></pre></td></tr></table></figure>

<h2 id="实现历程"><a href="#实现历程" class="headerlink" title="实现历程"></a>实现历程</h2><h3 id="App-Ops"><a href="#App-Ops" class="headerlink" title="App Ops"></a>App Ops</h3><p>Google在SDK19中引入了AppOps的权限管理方式，AppOpsManager是对外的管理接口，真正实现功能的是AppOpsService。AppOpsManager里面有两个比较重要的方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AppOpsManager::checkOp(int op ,int uid ,String packageName) （hide方法)</span><br><span class="line">AppOpsManager::checkOp(String op,int uid ,String packageName)（public方法）</span><br></pre></td></tr></table></figure>

<p>所以我们可以用第二个方式检测权限的状态，uid和packageName我们可以拿到，但是op是什么呢，通过查找我们发现AppOpsManager提供了一个函数permissionToOp，通过这个函数我们可以，我们可以把标题1中获取到的uses-permission转换成op，然后我们就可以利用checkOp获取到权限的状态结果了。<br>但是在实际的操作中我们发现。发生了一个SecurityException异常。这个是为什么呢，我们通过查看源码发现。permissionToOp可能为空，这个是因为，我们标题1中获取到的permission，不一定有对应的op值。部分展示如下所示：我们发现其中有好多null值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * This maps each operation to the public string constant for it.</span><br><span class="line"> * If it doesn&apos;t have a public string constant, it maps to null.</span><br><span class="line"> */</span><br><span class="line">private static String[] sOpToString = new String[] &#123;</span><br><span class="line">        OPSTR_COARSE_LOCATION,</span><br><span class="line">        OPSTR_FINE_LOCATION,</span><br><span class="line">        null,</span><br><span class="line">        null,</span><br><span class="line">        OPSTR_READ_CONTACTS,</span><br><span class="line">        OPSTR_WRITE_CONTACTS,</span><br><span class="line">        OPSTR_READ_CALL_LOG,</span><br><span class="line">        ......,</span><br><span class="line">        ......,</span><br><span class="line">        ......,</span><br><span class="line">        ......,</span><br><span class="line">        ......,</span><br><span class="line">        null,</span><br><span class="line">        OPSTR_USE_FINGERPRINT,</span><br><span class="line">        OPSTR_BODY_SENSORS,</span><br><span class="line">        OPSTR_READ_CELL_BROADCASTS,</span><br><span class="line">        OPSTR_MOCK_LOCATION,</span><br><span class="line">        OPSTR_READ_EXTERNAL_STORAGE,</span><br><span class="line">        OPSTR_WRITE_EXTERNAL_STORAGE,</span><br><span class="line">        null,</span><br><span class="line">        OPSTR_GET_ACCOUNTS,</span><br><span class="line">        null,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>结论：</p>
<p>1、通过permissionToOp和checkOp将不能满足我们的需求。</p>
<p>2、我们发现AndroidManifest.xml中的权限要比小米手机权限列表中的要多。</p>
<h3 id="SecurityCenter"><a href="#SecurityCenter" class="headerlink" title="SecurityCenter"></a>SecurityCenter</h3><p>SecurityCenter是什么，它是小米手机权限管理的apk，通过反编译，我们可以一步步的发现小米手机获取权限列表状态的实现方式。粘一下小米的实现核心代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public PermissionList loadInBackground() &#123;</span><br><span class="line">        PermissionList permissionList = new PermissionList();</span><br><span class="line">        permissionList.isEnabled = isEnabled();</span><br><span class="line">        HashMap cB = packagePermisson(this.mContext, packageName);</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;PermissionBean&gt; arrayList = new ArrayList();</span><br><span class="line">        permissionList.hashMap = cB;</span><br><span class="line">        permissionList.PermissionBeanList = arrayList;</span><br><span class="line">        if (cB != null) &#123;</span><br><span class="line">            Iterable&lt;PermissionGroupInfo&gt; boo = mo5980boo(0);</span><br><span class="line">            Iterable&lt;PermissionInfo&gt; bop = mo5981bop(0);</span><br><span class="line">            Set keySet = cB.keySet();</span><br><span class="line">            HashMap hashMap = new HashMap();</span><br><span class="line">            for (PermissionGroupInfo permissionGroupInfo : boo) &#123;</span><br><span class="line">                PermissionBean permissionBean = new PermissionBean();</span><br><span class="line">                permissionBean.permissionGroupInfo = permissionGroupInfo;</span><br><span class="line">                hashMap.put(Integer.valueOf(permissionGroupInfo.getId()), permissionBean);</span><br><span class="line">                arrayList.add(permissionBean);</span><br><span class="line">            &#125;</span><br><span class="line">            for (PermissionInfo permissionInfo : bop) &#123;</span><br><span class="line">                if (keySet.contains(Long.valueOf(permissionInfo.getId()))) &#123;</span><br><span class="line">                    PermissionBean permissionBean2 = (PermissionBean) hashMap.get(Integer.valueOf(permissionInfo.getGroup()));</span><br><span class="line">                    if (permissionBean2 != null) &#123;</span><br><span class="line">                        permissionBean2.permissionInfoArrayList.add(permissionInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ArrayList&lt;PermissionBean&gt; arrayList2 = new ArrayList();</span><br><span class="line">            for (PermissionBean permissionBean3 : arrayList) &#123;</span><br><span class="line">                if (permissionBean3.permissionInfoArrayList.size() == 0) &#123;</span><br><span class="line">                    arrayList2.add(permissionBean3);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            for (PermissionBean permissionBean32 : arrayList2) &#123;</span><br><span class="line">                arrayList.remove(permissionBean32);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return permissionList;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中，packagePermisson，mo5980boo，mo5981bop，都是通过ContentResolver跨进程获取到的，然后把获取到的权限分组拼装即可。所以，通过这种方式，我们获取到的权限状态和小米手机的权限列表是一致的。</p>
<p>结论：</p>
<p>因为上述实现是基于note 4x手机的安全中心获取的，所以没有问题。但是我们的手机型号不止是4x手机，还有其他小米手机，但我在其他手机上运行的时候，发现报错，出现没有miui.permission.READ_AND_WIRTE_PERMISSION_MANAGER的异常。所以，这种实现方式，不能支撑所有手机。</p>
<h3 id="AppOpsX"><a href="#AppOpsX" class="headerlink" title="AppOpsX"></a>AppOpsX</h3><p>是一个第三方权限管理的实现，通过调用appops的权限管理器，控制权限管理。<br>[Github:<a href="https://github.com/8enet/AppOpsX]" target="_blank" rel="noopener">https://github.com/8enet/AppOpsX]</a> (<a href="https://github.com/8enet/AppOpsX),接入AppOpsX后，可以支撑所有小米手机，但是获取到的权限列表不能和小米手机的权限中心一致，这个会导致产品和运营有一定的误解，并且接入比较困难，可能对今天版本的兼容也会有问题。" target="_blank" rel="noopener">https://github.com/8enet/AppOpsX),接入AppOpsX后，可以支撑所有小米手机，但是获取到的权限列表不能和小米手机的权限中心一致，这个会导致产品和运营有一定的误解，并且接入比较困难，可能对今天版本的兼容也会有问题。</a></p>
<h3 id="checkSelfPermission"><a href="#checkSelfPermission" class="headerlink" title="checkSelfPermission"></a>checkSelfPermission</h3><h4 id="ContextCompat"><a href="#ContextCompat" class="headerlink" title="ContextCompat"></a>ContextCompat</h4><p>Android 6.0 变更:<br>此版本引入了一种新的权限模式，如今，用户可直接在运行时管理应用权限。这种模式让用户能够更好地了解和控制权限，同时为应用开发者精简了安装和自动更新过程。用户可为所安装的各个应用分别授予或撤销权限。</p>
<p>对于以 Android 6.0（API 级别 23）或更高版本为目标平台的应用，请务必在运行时检查和请求权限。要确定您的应用是否已被授予权限，请调用新增的 checkSelfPermission() 方法。要请求权限，请调用新增的 requestPermissions() 方法。即使您的应用并不以 Android 6.0（API 级别 23）为目标平台，您也应该在新权限模式下测试您的应用。</p>
<p>如需了解有关在您的应用中支持新权限模式的详情，请参阅使用系统权限。如需了解有关如何评估新模式对应用的影响的提示，请参阅权限最佳做法。</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/02/permissioncheck/checkSelfPermission.png" alt="checkSelfPermission" title class>
                <p>checkSelfPermission</p>
            </figure>
<p>从上图可知，最终的check会到PackageManagerService. checkComponentPermission,而checkComponentPermission最终调用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public int checkUidPermission(String permName, int uid) &#123;</span><br><span class="line">    final int userId = UserHandle.getUserId(uid);</span><br><span class="line"></span><br><span class="line">    if (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        return PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronized (mPackages) &#123;</span><br><span class="line">        Object obj = mSettings.getUserIdLPr(UserHandle.getAppId(uid));</span><br><span class="line">        if (obj != null) &#123;</span><br><span class="line">            final SettingBase ps = (SettingBase) obj;</span><br><span class="line">            final PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line">            if (permissionsState.hasPermission(permName, userId)) &#123;</span><br><span class="line">                return PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">            // Special case: ACCESS_FINE_LOCATION permission includes ACCESS_COARSE_LOCATION</span><br><span class="line"> if (Manifest.permission.ACCESS_COARSE_LOCATION.equals(permName) &amp;&amp; permissionsState</span><br><span class="line">                    .hasPermission(Manifest.permission.ACCESS_FINE_LOCATION, userId)) &#123;</span><br><span class="line">                return PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            ArraySet&lt;String&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">            if (perms != null) &#123;</span><br><span class="line">                if (perms.contains(permName)) &#123;</span><br><span class="line">                    return PackageManager.PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">                if (Manifest.permission.ACCESS_COARSE_LOCATION.equals(permName) &amp;&amp; perms</span><br><span class="line">                        .contains(Manifest.permission.ACCESS_FINE_LOCATION)) &#123;</span><br><span class="line">                    return PackageManager.PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里最重要的就是mSettings，所有的权限信息都通过mSettings来获取，但是mSettings是都做了什么操作呢？看下边的图：</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/02/permissioncheck/setting.png" alt="setting" title class>
                <p>setting</p>
            </figure>
<p>Android6.0之前会吧所有的权限都放置在data/system/packages.xml文件中。Android6.0之后，分为运行时权限跟普通权限，普通权限还是放在data/system/packages.xml中，运行时权限防止在data/system/users/0/runtime-permissions.xml文件中。根据运行时是否动态申请去更新权限。而对于普通权限，一直都为true。<br>具体的实例信息如下：</p>
<p><strong><em>packages.xml</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;package name=&quot;com.permisison.naga&quot; codePath=&quot;/data/app/com.wuba.tinyhand-2&quot; nativeLibraryPath=&quot;/data/app/com.wuba.tinyhand-2/lib&quot; primaryCpuAbi=&quot;armeabi&quot; publicFlags=&quot;944291398&quot; privateFlags=&quot;0&quot; ft=&quot;166817e48c8&quot; it=&quot;16615425c49&quot; ut=&quot;166817e51fc&quot; version=&quot;2540&quot; userId=&quot;10141&quot;&gt;</span><br><span class="line">        &lt;sigs count=&quot;1&quot;&gt;</span><br><span class="line">            &lt;cert index=&quot;11&quot; /&gt;</span><br><span class="line">        &lt;/sigs&gt;</span><br><span class="line">        &lt;perms&gt;</span><br><span class="line">            &lt;item name=&quot;android.permission.WRITE_SETTINGS&quot; granted=&quot;true&quot; flags=&quot;0&quot; /&gt;</span><br><span class="line">            &lt;item name=&quot;android.permission.RESTART_PACKAGES&quot; granted=&quot;true&quot; flags=&quot;0&quot; /&gt;</span><br><span class="line">            &lt;item name=&quot;android.permission.SYSTEM_ALERT_WINDOW&quot; granted=&quot;true&quot; flags=&quot;0&quot; /&gt;</span><br><span class="line">        &lt;/perms&gt;</span><br><span class="line">        &lt;proper-signing-keyset identifier=&quot;28&quot; /&gt;</span><br><span class="line">    &lt;/package&gt;</span><br></pre></td></tr></table></figure>

<p><strong><em>runtime-permissions.xml</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;pkg name=&quot;com.permisison.naga&quot;&gt;</span><br><span class="line">    &lt;item name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot; granted=&quot;true&quot; flags=&quot;2&quot; /&gt;</span><br><span class="line">    &lt;item name=&quot;android.permission.READ_PHONE_STATE&quot; granted=&quot;true&quot; flags=&quot;2&quot; /&gt;</span><br><span class="line">    &lt;item name=&quot;android.permission.SEND_SMS&quot; granted=&quot;false&quot; flags=&quot;2&quot; /&gt;</span><br><span class="line">    &lt;item name=&quot;android.permission.PROCESS_OUTGOING_CALLS&quot; granted=&quot;true&quot; flags=&quot;2&quot; /&gt;</span><br><span class="line">    &lt;item name=&quot;android.permission.GET_ACCOUNTS&quot; granted=&quot;true&quot; flags=&quot;2&quot; /&gt;</span><br><span class="line">    &lt;item name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot; granted=&quot;true&quot; flags=&quot;2&quot; /&gt;</span><br><span class="line">  &lt;/pkg&gt;</span><br></pre></td></tr></table></figure>

<p>结论：</p>
<p>1、checkSelfPermission会分别判断两个xml文件，packages.xml是普通权限，并且一直返回true，runtime-permissions.xml返回的是动态权限的状态，会根据当前设置返回0和-1，0是授予，-1是未被授予权限。</p>
<p>2、国内手机厂商的rom都是修改过了，并且增加了不少自定义的权限，所以这个方法获取的结果是不全的。</p>
<h4 id="PermissionChecker"><a href="#PermissionChecker" class="headerlink" title="PermissionChecker"></a>PermissionChecker</h4><p>直接看下关键代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public static int checkPermission(@NonNull Context context, @NonNull String permission,</span><br><span class="line">        int pid, int uid, String packageName) &#123;</span><br><span class="line">    if (context.checkPermission(permission, pid, uid) == PackageManager.PERMISSION_DENIED) &#123;</span><br><span class="line">        return PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String op = AppOpsManagerCompat.permissionToOp(permission);</span><br><span class="line">    if (op == null) &#123;</span><br><span class="line">        return PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (packageName == null) &#123;</span><br><span class="line">        String[] packageNames = context.getPackageManager().getPackagesForUid(uid);</span><br><span class="line">        if (packageNames == null || packageNames.length &lt;= 0) &#123;</span><br><span class="line">            return PERMISSION_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">        packageName = packageNames[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (AppOpsManagerCompat.noteProxyOp(context, op, packageName)</span><br><span class="line">            != AppOpsManagerCompat.MODE_ALLOWED) &#123;</span><br><span class="line">        return PERMISSION_DENIED_APP_OP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return PERMISSION_GRANTED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>里面有这么一句判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String op = AppOpsManagerCompat.permissionToOp(permission);</span><br><span class="line">if (op == null) &#123;</span><br><span class="line">        return PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p> AppOpsManager返回为null的permission，都返回PERMISSION_GRANTED=0；这个判断就不准确了，如果一个运行时权限，没有在这个里面，那就永远为o了。即使设置了拒绝，也获取不到PERMISSION_DENIED=1。并且，小米手机设置好多10000以上都op自定义权限，肯定是获取不到，并且有些权限还没有permission。</p>
<p>结论：完全不可用。继续尝试</p>
<h3 id="AuthManager"><a href="#AuthManager" class="headerlink" title="AuthManager"></a>AuthManager</h3><p>通过上述一些列的验证，都是不可以采用的结论。最终我们再次回到note 4x的实现方案上来。由于再标题2的时候，我们只是调研了获取权限状态的方式，但是没有深入的调研底层实现。所以我们通过一些列跟踪，最终找到具体的实现地方在AuthManager这个app下。</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/02/permissioncheck/authmanager.png" alt="authmanager" title class>
                <p>authmanager</p>
            </figure>
<p>结论：</p>
<p>1、由上图可以看出，小米手机完全自己封装了一层权限管理，它的权限状态都存储在了miui_ngen.db数据库里，并且通过PermissionManager管理并定义了权限的op和android.permission值。</p>
<p>2、既然update时完全操作了db和xml三个文件。那我们是不是可以用反射的方法实现呢？经过实现，利用反射checkOpNoThrow虽然可以获取到具体状态值，但是我们只能获取到当前的权限，不能获取到第三方app的权限，报<br>java.lang.SecurityException: uid 10141 does not have android.permission.UPDATE_APP_OPS_STATS异常。</p>
<p>3、开发过程中，发现某些运行权限op=59的权限不能改变，一致获取到的是0.即授权的状态。<br>所以利用反射我们也不能实现我们的需求，继续。</p>
<h3 id="runtime-permissions-xml与appops-xml"><a href="#runtime-permissions-xml与appops-xml" class="headerlink" title="runtime-permissions.xml与appops.xml"></a>runtime-permissions.xml与appops.xml</h3><p>经过调研后发现，当我们在修改权限的状态值时，不仅appops.xml里面的状态值在该比那，而且运行权限runtime-permissions.xml的值也在改变，那我们是不是可以比较两个文件的内容进行获取状态值呢。 首先，我们需要读取文件，但是我们没有读取文件权限，我们需要copy到sdcard进行解析。解析过程如下图：</p>
<figure class="image-box">
                <img src="http://nunu03.github.io/2019/07/02/permissioncheck/verify.png" alt="verify" title class>
                <p>verify</p>
            </figure>

<h3 id="miui-ngen-db"><a href="#miui-ngen-db" class="headerlink" title="miui_ngen.db"></a>miui_ngen.db</h3><p>miui_ngen.db是什么？我们都知道是一个数据库文件，而且这个是miui的权限状态管理文件。任何的App权限状态都一一对应的存在了这个文件里。从而由上述6种的操作，我们受到了一定的启发，既然能够拿到xml文件，那我们是不是也可以直接拿到这个db文件，然后直接读取db，获取状态信息呢？经过尝试，好吧，权限检测的最终方案决定下来了，我们完全可以直接读取这个db文件，获取到准确的，和miui权限管理中心一一对应，完全匹配的权限状态。</p>
<p><strong>总结：通过以上步骤的实现过程，我们发现由于国内厂商对rom的定制，可能完全修改或者封装了权限的实现和检测机制，我们通过一步步的测试和添坑，最终还是回到了手机原本自身的检测机制上来，并且这种方式是最准确的方式。</strong></p>
<h2 id="对权限的处理场景"><a href="#对权限的处理场景" class="headerlink" title="对权限的处理场景"></a>对权限的处理场景</h2><p>如果设备运行的是 Android 6.0（API 级别 23）或更高版本，并且应用的 targetSdkVersion 是 23 或更高版本，则应用在运行时向用户请求权限。用户可随时调用权限，因此应用在每次运行时均需检查自身是否具备所需的权限。</p>
<p>如果设备运行的是 Android 5.1（API 级别 22）或更低版本，并且应用的 targetSdkVersion 是 22 或更低版本，则系统会在用户安装应用时要求用户授予权限。如果将新权限添加到更新的应用版本，系统会在用户更新应用时要求授予该权限。用户一旦安装应用，他们撤销权限的唯一方式是卸载应用。</p>
<p>如果设备运行的是 Android 6.0（API 级别 23）或更高版本，并且应用的 targetSdkVersion 是 22 或更低版本， 此时Android系统会把你申请的全部权限都给你 。 用户依然可以进入App的设置界面把权限关闭 ！</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://developer.android.com/about/versions/marshmallow/android-6.0-changes?hl=zh-cn#behavior-runtime-permissions" target="_blank" rel="noopener">https://developer.android.com/about/versions/marshmallow/android-6.0-changes?hl=zh-cn#behavior-runtime-permissions</a><br><a href="https://blog.csdn.net/lewif/article/details/49124757" target="_blank" rel="noopener">https://blog.csdn.net/lewif/article/details/49124757</a><br><a href="https://blog.csdn.net/happylishang/article/details/53813779" target="_blank" rel="noopener">https://blog.csdn.net/happylishang/article/details/53813779</a><br><a href="https://mp.weixin.qq.com/s/OQRHEufCUXBA3d3DMZXMKQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/OQRHEufCUXBA3d3DMZXMKQ</a><br><a href="https://developer.android.com/reference/android/support/v4/content/ContextCompat#checkSelfPermission(android.content.Context,%20java.lang.String)" target="_blank" rel="noopener">https://developer.android.com/reference/android/support/v4/content/ContextCompat#checkSelfPermission(android.content.Context,%20java.lang.String)</a><br><a href="https://developer.android.com/reference/android/content/pm/PackageManager#PERMISSION_DENIED" target="_blank" rel="noopener">https://developer.android.com/reference/android/content/pm/PackageManager#PERMISSION_DENIED</a><br><a href="https://www.jianshu.com/p/0ddd129dd32b" target="_blank" rel="noopener">https://www.jianshu.com/p/0ddd129dd32b</a><br><a href="https://blog.csdn.net/happylishang/article/details/78222788" target="_blank" rel="noopener">https://blog.csdn.net/happylishang/article/details/78222788</a><br><a href="https://www.cnblogs.com/neo-java/p/7117482.html" target="_blank" rel="noopener">https://www.cnblogs.com/neo-java/p/7117482.html</a></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Kotlin新手使用笔记]]></title>
      <url>/2019/07/02/kotlinnotes/</url>
      <content type="html"><![CDATA[<h2 id="const关键字"><a href="#const关键字" class="headerlink" title="const关键字"></a>const关键字</h2><p>只读属性使用const关键字之后将没有get方法，举个例子<br>在kotlin文件中，写两个包级属性，一个是const，一个不是const</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const val i = 1</span><br><span class="line">val j = &quot;A&quot;</span><br></pre></td></tr></table></figure>

<a id="more"></a>
<p>使用java代码访问，访问方式是不同的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class TestConst &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        int i = ConstKt.i;</span><br><span class="line">        ConstKt.getJ();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一种是使用get方法访问，一种是直接使用类访问。说明const关键字实际上相当于java的static final。<br>需要注意的是，Const只能是kotlin的string和基本类型。<br>其实在object中const相当于@JvmField注解，比如下面的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@JvmField</span><br><span class="line">val c = 3</span><br></pre></td></tr></table></figure>

<p>就和</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const val c = 3</span><br></pre></td></tr></table></figure>

<p>效果一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@JvmField</span><br><span class="line">val TAGS = WeixinHook.TAG + &quot;.Test&quot;</span><br><span class="line">const val TAGSG = WeixinHook.TAG + &quot;.Test&quot;</span><br><span class="line">    </span><br><span class="line">@NotNull</span><br><span class="line">@JvmField</span><br><span class="line">public static final String TAGS = &quot;hotB.wechat.Test&quot;;</span><br><span class="line">@NotNull</span><br><span class="line">public static final String TAGSG = &quot;hotB.wechat.Test&quot;;</span><br></pre></td></tr></table></figure>

<p>在class中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private const val TAG = XLog.hotPanel + &quot;DeviceUtil&quot;</span><br><span class="line">class DeviceUtil&#123;&#125;</span><br><span class="line"></span><br><span class="line">生成了另一个文件存储const</span><br><span class="line">public final class DeviceUtilKt &#123;</span><br><span class="line">    /* renamed from: MB */</span><br><span class="line">    private static final long f14MB = 1048576;</span><br><span class="line">    private static final String TAG = &quot;hotPanel.DeviceUtil&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是kotlin中const关键字的本质。<br><a href="https://blog.csdn.net/ilovewqf/article/details/78826373" target="_blank" rel="noopener">原文点击</a></p>
<h2 id="静态内部类，常量，三元运算符"><a href="#静态内部类，常量，三元运算符" class="headerlink" title="静态内部类，常量，三元运算符"></a>静态内部类，常量，三元运算符</h2><p>静态内部变量和常量定义方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">companion object &#123;</span><br><span class="line">        private const val MSG_UPDATE_PROGRESS = 1</span><br><span class="line">        private const val MSG_UPDATE_TIME= 1000</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>静态内部类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Parent&#123;</span><br><span class="line">    class Child //默认就是 java的 public static</span><br><span class="line">&#125;</span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    val inner = Parent.Child()</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>非静态内部类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Parent&#123;</span><br><span class="line">    //非静态内部类声明</span><br><span class="line">    inner class Child</span><br><span class="line">&#125;</span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    val inner = Parent().Child()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内部类访问外部持有类的this</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class Parent&#123;</span><br><span class="line">    val a:Int = 0</span><br><span class="line">    inner class Child&#123;</span><br><span class="line">        val a:Int = 5</span><br><span class="line">        fun hello()&#123;</span><br><span class="line">            println(this@Parent.a)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    val inner = Parent().Child()</span><br><span class="line">    inner.hello()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三元运算符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> //Java写法</span><br><span class="line">int size=list!=null?list.size:0</span><br><span class="line">//kotlin写法</span><br><span class="line">val size=if(list!=null) list.size() else 0</span><br></pre></td></tr></table></figure>

<p><a href="https://blog.csdn.net/weixin_34032621/article/details/86817626" target="_blank" rel="noopener">原文点击</a></p>
<h2 id="readLine赋值为空"><a href="#readLine赋值为空" class="headerlink" title="readLine赋值为空"></a>readLine赋值为空</h2><p>Java中有一个判断是 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if（（str=bufferedReader.readLine()）!= null）</span><br></pre></td></tr></table></figure>

<p>这句话到了kotlin转不过来,java经过强制转换成kotlin，可能最初我们是这么写的 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var str=bufferedReader.readLine() </span><br><span class="line">while(str != null)&#123; </span><br><span class="line">执行代码 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可是出oom了，问题在哪呢？不说了。最后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var line: String</span><br><span class="line">while (true) &#123;</span><br><span class="line">    line = bufferedReader.readLine() ?: break</span><br><span class="line">    buffer.append(line)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><p>val:val属性只提供getter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">val usbState: UsbState</span><br><span class="line">    get() = sUsbState.copy()</span><br><span class="line">编译后的：</span><br><span class="line">@NotNull</span><br><span class="line">public final UsbState getUsbState() &#123;</span><br><span class="line">    return UsbMonitor.sUsbState.copy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>var：默认生成getter，setter方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var usbConnected: Boolean = false</span><br><span class="line">public final boolean getUsbConnected() &#123;</span><br><span class="line">    return this.usbConnected;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public final void setUsbConnected(boolean &lt;set-?&gt;) &#123;</span><br><span class="line">    this.usbConnected = &lt;set-?&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="对象表达式-amp-amp-对象声明-amp-amp-伴生对象"><a href="#对象表达式-amp-amp-对象声明-amp-amp-伴生对象" class="headerlink" title="对象表达式 &amp;&amp; 对象声明 &amp;&amp; 伴生对象"></a>对象表达式 &amp;&amp; 对象声明 &amp;&amp; 伴生对象</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">var btn: Button = findViewById(R.id.btn)</span><br><span class="line">// 对象表达式实现匿名内部类</span><br><span class="line">btn.setOnClickListener(object: View.OnClickListener &#123;</span><br><span class="line">    override fun onClick(v: View?) &#123;</span><br><span class="line">        text.setText(&quot;$&#123;text.text&#125; $&#123;++clickTime&#125;&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">// OnClickListener是函数式接口，可使用Lambda表达式</span><br><span class="line">btn.setOnClickListener &#123; view -&gt;</span><br><span class="line">    text.setText(&quot;$&#123;text.text&#125; $&#123;++clickTime&#125;&quot;)</span><br><span class="line">&#125;</span><br><span class="line">// 对象声明---单例</span><br><span class="line">object FoodManager &#123;</span><br><span class="line">    var foods: MutableList&lt;String&gt;</span><br><span class="line">    init&#123;</span><br><span class="line">        foods = mutableListOf&lt;String&gt;()</span><br><span class="line">        // 初始化食物池</span><br><span class="line">        for (i in 1..9) &#123;</span><br><span class="line">            foods.add(&quot;food$&#123;i&#125;&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">var foods = FoodManager.foods // 使用对象声明</span><br><span class="line">// 伴生对象---静态成员</span><br><span class="line">interface Outputable&#123;</span><br><span class="line">    fun output(msg: String)</span><br><span class="line">&#125;</span><br><span class="line">class MyClass&#123;</span><br><span class="line">    // 定义的MyClass的伴生对象</span><br><span class="line">    companion object: Outputable&#123;</span><br><span class="line">        val name = ”name属性值” </span><br><span class="line">        </span><br><span class="line">        //重写父接口中的抽象方法</span><br><span class="line">        override fun output(msg: String) &#123;</span><br><span class="line">            for(i in 1..6)&#123;</span><br><span class="line">                println (”&lt;h$(i&#125;&gt;$&#123; msg&#125;&lt;/h$&#123;i&#125;&gt;”)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    // 调用伴生对象里的方法与属性，与调用静态成员一样</span><br><span class="line">    MyClass.output(&quot;fkit.org&quot;)</span><br><span class="line">    println(MyClass.name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="对象声明定义常量"><a href="#对象声明定义常量" class="headerlink" title="对象声明定义常量"></a>对象声明定义常量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">object NetUtils &#123;</span><br><span class="line"> /**</span><br><span class="line">     * 移动</span><br><span class="line">     */</span><br><span class="line">    const val PROVIDER_TYPE_MOVE = 1</span><br><span class="line">    /**</span><br><span class="line">     * 联通</span><br><span class="line">     */</span><br><span class="line">    const val PROVIDER_TYPE_UNICOM = 2</span><br><span class="line">    /**</span><br><span class="line">     * 电信</span><br><span class="line">     */</span><br><span class="line">    const val PROVIDER_TYPE_TELECOM = 3</span><br><span class="line"></span><br><span class="line">    val NET_TYPE_MOVE = &quot;10086&quot;</span><br><span class="line">    val NET_TYPE_UNICOM = &quot;10010&quot;</span><br><span class="line">    val NET_TYPE_TELECOM = &quot;10001&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于对象声明定义的数据单例，所以一般调用(.java)都会用Class.INSTANCE.getXXXX，(kotlin)会用Class.XXXX，但是如果对象中声明的是const常量，则只能用Class.XXXX调用。<br>举例说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">switch (NetUtils.INSTANCE.providerType(WxVersions.CURRENT_APPLICATION)) &#123;</span><br><span class="line">            case NetUtils.PROVIDER_TYPE_MOVE:</span><br><span class="line">                destinationAddress = NetUtils.INSTANCE.getNET_TYPE_MOVE();</span><br><span class="line">                break;</span><br><span class="line">            case NetUtils.PROVIDER_TYPE_UNICOM:</span><br><span class="line">                destinationAddress = NetUtils.INSTANCE.getNET_TYPE_UNICOM();</span><br><span class="line">                break;</span><br><span class="line">            case NetUtils.PROVIDER_TYPE_TELECOM:</span><br><span class="line">                destinationAddress = NetUtils.INSTANCE.getNET_TYPE_TELECOM();</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                destinationAddress = null;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>反编译后的NetUtils</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public final class NetUtils &#123;</span><br><span class="line">    public static final NetUtils INSTANCE = new NetUtils();</span><br><span class="line">    @NotNull</span><br><span class="line">    private static final String NET_TYPE_MOVE = NET_TYPE_MOVE;</span><br><span class="line">    @NotNull</span><br><span class="line">    private static final String NET_TYPE_TELECOM = NET_TYPE_TELECOM;</span><br><span class="line">    @NotNull</span><br><span class="line">    private static final String NET_TYPE_UNICOM = NET_TYPE_UNICOM;</span><br><span class="line">    public static final int PROVIDER_TYPE_MOVE = 1;</span><br><span class="line">    public static final int PROVIDER_TYPE_TELECOM = 3;</span><br><span class="line">    public static final int PROVIDER_TYPE_UNICOM = 2;</span><br><span class="line"></span><br><span class="line">    private NetUtils() &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果定义的常量没有加const，则在调用的时候要用Class.INSTANCE.getXXXX，但是，这个时候switch，会报constant expression requierd异常。</p>
<p><strong>注意：伴生对象常量定义方式：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class MicroMsg &#123;</span><br><span class="line">	companion object &#123;</span><br><span class="line">		val DB_NAME = &quot;EnMicroMsg.db&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">而下面这样写法拿不到DB_NAME</span><br><span class="line">class MicroMsg &#123;</span><br><span class="line">	val DB_NAME = &quot;EnMicroMsg.db&quot;</span><br><span class="line">	companion object &#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>伴生对象如何生成public static final</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class MicroMsg &#123;</span><br><span class="line">	companion object &#123;</span><br><span class="line">		 val TYPE_IMG = 1</span><br><span class="line">        val TYPE_FILE = 2</span><br><span class="line">        const val TYPE_VOICE = 3</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">反编译后</span><br><span class="line">private static final int TYPE_FILE = 2;</span><br><span class="line">private static final int TYPE_IMG = 1;</span><br><span class="line">public static final int TYPE_VOICE = 3;</span><br></pre></td></tr></table></figure>

<h2 id="constructor构造器"><a href="#constructor构造器" class="headerlink" title="constructor构造器"></a>constructor构造器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.主构造器</span><br><span class="line">class MultiTask&lt;TaskData, Result&gt; constructor(private val mTaskItem: TaskItem, private val mRequest: TaskData, private val mTaskCount: Int, private val mDelay: Long = 500) </span><br><span class="line"></span><br><span class="line">2.主构造器可以省略constructor</span><br><span class="line">class MultiTask&lt;TaskData, Result&gt; (private val mTaskItem: TaskItem, private val mRequest: TaskData, private val mTaskCount: Int, private val mDelay: Long = 500) </span><br><span class="line"></span><br><span class="line">3.主构造器如果有@JvmOverloads则不可以省略constructor</span><br><span class="line">class MultiTask&lt;TaskData, Result&gt; @JvmOverloads constructor(private val mTaskItem: TaskItem, private val mRequest: TaskData, private val mTaskCount: Int, private val mDelay: Long = 500) </span><br><span class="line"></span><br><span class="line">4.使用@JvmOverloads注解的主构造器，不可以再有次构造器</span><br><span class="line">	constructor(taskItem: TaskItem,mRequest: TaskData,mTaskCount: Int): this(taskItem, mRequest,mTaskCount,300) &#123;</span><br><span class="line">&#125;</span><br><span class="line">异常，hava the same JVM signature.</span><br></pre></td></tr></table></figure>

<p><strong>构造器几种使用：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">空构造器</span><br><span class="line">class OuterConstructor&#123;&#125;</span><br><span class="line"></span><br><span class="line">私有构造器</span><br><span class="line">class OuterConstructor private constructor(str:String, ins:Int)&#123;&#125;</span><br><span class="line"></span><br><span class="line">私有构造器+次构造器（可调）</span><br><span class="line">class OuterConstructor private constructor(str:String, ins:Int)&#123;</span><br><span class="line">    var s1 = &quot;123&quot;</span><br><span class="line">    init&#123;</span><br><span class="line">        this.s1 = str</span><br><span class="line">    &#125;</span><br><span class="line">    constructor(str:String):this(str,8)</span><br><span class="line">&#125;</span><br><span class="line">主构造器</span><br><span class="line">class OuterConstructor constructor(str:String, ins:Int)&#123;</span><br><span class="line">    var s1 = &quot;123&quot;</span><br><span class="line">    init&#123;</span><br><span class="line">        this.s1 = str</span><br><span class="line">    &#125;</span><br><span class="line">    constructor(str:String):this(str,8)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">主构造器省略初始化init</span><br><span class="line">class OuterConstructor &#123;</span><br><span class="line">    var s1 = &quot;123&quot;</span><br><span class="line">    init&#123;</span><br><span class="line">        this.s1 = &quot;qdf&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">主构造器初始化init</span><br><span class="line">class OuterConstructor constructor(str:String, ins:Int)&#123;</span><br><span class="line">    var s1 = &quot;123&quot;</span><br><span class="line">    init&#123;</span><br><span class="line">        this.s1 = str</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JvmOverloads作用"><a href="#JvmOverloads作用" class="headerlink" title="@JvmOverloads作用"></a>@JvmOverloads作用</h3><p>在有默认参数值的方法中使用@JvmOverloads注解，则Kotlin就会暴露多个重载方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@JvmOverloads fun f(a: String, b: Int=0, c:String=&quot;abc&quot;)&#123;</span><br><span class="line">&#125;</span><br><span class="line">反编译后：</span><br><span class="line">void f(String a)</span><br><span class="line">void f(String a, int b)</span><br><span class="line">void f(String a, int b, String c)</span><br></pre></td></tr></table></figure>

<p>所以@JvmOverloads不仅仅用于构造方法。</p>
<h3 id="constructor中参数指定val-var和没有制定的区别"><a href="#constructor中参数指定val-var和没有制定的区别" class="headerlink" title="constructor中参数指定val,var和没有制定的区别"></a>constructor中参数指定val,var和没有制定的区别</h3><h4 id="不指定"><a href="#不指定" class="headerlink" title="不指定"></a>不指定</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class OuterConstructor constructor(mHookConfig: HookConfig) </span><br><span class="line">反编译后</span><br><span class="line">public AvatarServiceImplKT(@NotNull HookConfig mHookConfig) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="val"><a href="#val" class="headerlink" title="val"></a>val</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class OuterConstructor constructor(val mHookConfig: HookConfig) </span><br><span class="line">反编译后</span><br><span class="line">private final HookConfig mHookConfig;</span><br><span class="line">public AvatarServiceImplKT(@NotNull HookConfig mHookConfig) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="var"><a href="#var" class="headerlink" title="var"></a>var</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class OuterConstructor constructor(var mHookConfig: HookConfig) </span><br><span class="line">反编译后</span><br><span class="line">private HookConfig mHookConfig;</span><br><span class="line">public AvatarServiceImplKT(@NotNull HookConfig mHookConfig) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="vararg可变参数"><a href="#vararg可变参数" class="headerlink" title="vararg可变参数"></a>vararg可变参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fun print(vararg msgs: String) &#123;</span><br><span class="line">    for (msg in msgs) &#123;</span><br><span class="line">    	println(msg)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun LogPrinters()&#123;</span><br><span class="line">	print(&quot;11&quot;,&quot;22&quot;,&quot;33&quot;,&quot;44&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是如果是下面这样调用是不可以的，会报参数匹配异常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val array = arrayOf(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;)</span><br><span class="line">print(array)</span><br></pre></td></tr></table></figure>

<p>如果想调用，需要使用*操作符：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(*array)</span><br></pre></td></tr></table></figure>

<p>所以我们调用带有可变参数的方法时，只能传递离散的参数值，直接传递数组会报语法错误。但是当我们手头上就是一个数组，要想传递，就需要借助运算符*(spread operator)：相当于将数组分散成一个个的个体再传入进去。</p>
<h2 id="var-get-set-xxx-方法"><a href="#var-get-set-xxx-方法" class="headerlink" title="var get() set(xxx)方法"></a>var get() set(xxx)方法</h2><p>1.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">override var name: String=&quot;ninhao&quot;</span><br><span class="line">	get() = field</span><br><span class="line">	set(value) &#123;</span><br><span class="line">		field=value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">XLog.e(&quot;------name1:&quot;,name)</span><br><span class="line">name = &quot;henhao&quot;</span><br><span class="line">XLog.e(&quot;------name2:&quot;,name)</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ninhao</span><br><span class="line">henhao</span><br></pre></td></tr></table></figure>

<p>注意：var name: String=”ninhao”，必须初始化。<br>2.可以通过fun get() 和fun set(XXX)实现。</p>
<p>3.<br>错误写法：死循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var name: String</span><br><span class="line">	get() = name</span><br><span class="line">	set(value) &#123;</span><br><span class="line">	name=&quot;afff&quot;</span><br><span class="line">&#125;</span><br><span class="line">反编译后</span><br><span class="line"></span><br><span class="line">@NotNull</span><br><span class="line">public String getName() &#123;</span><br><span class="line">    return getName();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void setName(@NotNull String value) &#123;</span><br><span class="line">    Intrinsics.checkParameterIsNotNull(value, UserInfo.COLUMN_value);</span><br><span class="line">    setName(&quot;afff&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.runoob.com/kotlin/kotlin-class-object.html" target="_blank" rel="noopener">详细注解链接</a></p>
<h2 id="split"><a href="#split" class="headerlink" title="split"></a>split</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var sb = StringBuilder()</span><br><span class="line">sb.append(&quot;111,&quot;).append(&quot;222,&quot;).append(&quot;333,&quot;).append(&quot;,&quot;).append(&quot;aaa,&quot;).append(&quot;bbb,&quot;).append(&quot;ccc,&quot;).append(&quot;&quot;)</span><br><span class="line">val strs = sb.toString()</span><br><span class="line">val splits = strs.split(&quot;,&quot;.toRegex()).dropWhile &#123; !it.isEmpty() &#125;.toTypedArray()</span><br><span class="line">for(str in splits)&#123;</span><br><span class="line">	XLog.e(&quot;-------split:&quot;,str)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.<strong>dropWhile</strong> 返回从第一项起，去掉满足条件的元素，直到不满足条件的一项为止；<br>it.isEmpty():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-------split:][main]</span><br><span class="line">[-------split:][main]aaa</span><br><span class="line">[-------split:][main]bbb</span><br><span class="line">[-------split:][main]ccc</span><br><span class="line">[-------split:][main]</span><br></pre></td></tr></table></figure>

<p>!it.isEmpty():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-------split:][main]111</span><br><span class="line">[-------split:][main]222</span><br><span class="line">[-------split:][main]333</span><br><span class="line">[-------split:][main]</span><br><span class="line">[-------split:][main]aaa</span><br><span class="line">[-------split:][main]bbb</span><br><span class="line">[-------split:][main]ccc</span><br><span class="line">[-------split:][main]</span><br></pre></td></tr></table></figure>

<p>2.<strong>dropLastWhile</strong> 返回从最后一项起，去掉满足条件的元素，直到不满足条件的一项为止；<br>it.isEmpty():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-------split:][main]111</span><br><span class="line">[-------split:][main]222</span><br><span class="line">[-------split:][main]333</span><br><span class="line">[-------split:][main]</span><br><span class="line">[-------split:][main]aaa</span><br><span class="line">[-------split:][main]bbb</span><br><span class="line">[-------split:][main]ccc</span><br></pre></td></tr></table></figure>

<p>!it.isEmpty():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-------split:][main]111</span><br><span class="line">[-------split:][main]222</span><br><span class="line">[-------split:][main]333</span><br><span class="line">[-------split:][main]</span><br><span class="line">[-------split:][main]aaa</span><br><span class="line">[-------split:][main]bbb</span><br><span class="line">[-------split:][main]ccc</span><br><span class="line">[-------split:][main]</span><br></pre></td></tr></table></figure>

<p>3.<strong>drop</strong> 返回去掉前n个元素后的列表；<br>drop(4)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[-------split:][main]aaa</span><br><span class="line">[-------split:][main]bbb</span><br><span class="line">[-------split:][main]ccc</span><br><span class="line">[-------split:][main]</span><br></pre></td></tr></table></figure>

<p>4.<strong>filter &amp; slice &amp; take</strong></p>
<p>filter–过滤掉所有不满足条件的元素；<br>filterNot–过滤掉所有满足条件的元素；<br>filterNotNull–过滤掉所有值为null的元素；</p>
<p>slice–过滤掉非指定下标的元素，即保留下标对应的元素过滤List中指定下标的元素（比如这里只保留下标为1，3，4的元素），当过滤list中有元素值大于目标List大小时会出现异常；</p>
<p>take–返回从第一个开始的n个元素；<br>takeLast–返回从最后一个开始的n个元素；<br>takeWhile–返回不满足条件的下标前面的所有元素的集合；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filter &#123; !it.isEmpty() &#125;</span><br><span class="line"></span><br><span class="line">[-------split:][main]111</span><br><span class="line">[-------split:][main]222</span><br><span class="line">[-------split:][main]333</span><br><span class="line">[-------split:][main]aaa</span><br><span class="line">[-------split:][main]bbb</span><br><span class="line">[-------split:][main]ccc</span><br></pre></td></tr></table></figure>

<p><a href="https://www.cnblogs.com/tgyf/p/6892551.html?utm_source=itdadao&utm_medium=referral" target="_blank" rel="noopener">参考链接点击</a></p>
<h2 id="显式转换-amp-强制转换"><a href="#显式转换-amp-强制转换" class="headerlink" title="显式转换&amp;强制转换"></a>显式转换&amp;强制转换</h2><p>每个数字类型支持如下的转换:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; toByte(): Byte</span><br><span class="line">&gt; toShort(): Short</span><br><span class="line">&gt; toInt(): Int</span><br><span class="line">&gt; toLong(): Long</span><br><span class="line">&gt; toFloat(): Float</span><br><span class="line">&gt; toDouble(): Double</span><br><span class="line">&gt; toChar(): Char</span><br></pre></td></tr></table></figure>

<p>强制转换<br>xxx as 类：强制转换，可能崩溃</p>
<p>xxx as? 类：安全的强制转换，转换失败返回null</p>
<p><strong>注意：数字类型的转换也可以使用as ，编译时不报错，但运行时会报错。</strong></p>
<h2 id="Lambda-argument-should-be-moved-out-of-parentheses"><a href="#Lambda-argument-should-be-moved-out-of-parentheses" class="headerlink" title="Lambda argument should be moved out of parentheses"></a>Lambda argument should be moved out of parentheses</h2><p>解决方式：option+enter；</p>
<h2 id="return-标签"><a href="#return-标签" class="headerlink" title="return@标签"></a>return@标签</h2><p>跳转到指定的位置，标签的写法很简单，只需要名字之后加@符号，要用的时候@名字就好，一般在lambda表达式中可能会用到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fun print(vararg msgs: String) &#123;</span><br><span class="line">        Async.io &#123;</span><br><span class="line">            for (msg in msgs) &#123;</span><br><span class="line">                XLog.e(&quot;-------print:&quot;,msg)</span><br><span class="line">            &#125;</span><br><span class="line">            return@io</span><br><span class="line">            XLog.e(&quot;-------print:&quot;,&quot;8&quot;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        XLog.e(&quot;-------print:&quot;,&quot;9&quot;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-------print:][main]9</span><br><span class="line">[-------print:][IOExecutor#1]a</span><br><span class="line">[-------print:][IOExecutor#1]b</span><br><span class="line">[-------print:][IOExecutor#1]c</span><br><span class="line">[-------print:][IOExecutor#1]d</span><br></pre></td></tr></table></figure>

<h2 id="for循环使用方法"><a href="#for循环使用方法" class="headerlink" title="for循环使用方法"></a>for循环使用方法</h2><p>在Kotlin中想遍历1-100的数值可以这样写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (index in 1..10)&#123;</span><br><span class="line">	print(index)//会输出1..10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样写是正序遍历，如果想倒序遍历就该使用标准库中定义的downTo()函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (index in 10 downTo 1)&#123;</span><br><span class="line">	print(index)//会输出10..1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>想不使用1作为遍历的步长，可以使用step()函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (index in 1..100 step 2)&#123;</span><br><span class="line">	print(index)//会输出1..3..5......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要创建一个不包含末尾元素的区间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (index in 1 until 10)&#123;</span><br><span class="line">	println(index)//输出1..9</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历一个数组/列表，想同时取出下标和元素：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">val array = arrayOf(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</span><br><span class="line">for ((index,e) in array.withIndex())&#123;</span><br><span class="line">	println(&quot;下标=$index----元素=$e&quot;)</span><br><span class="line">&#125;</span><br><span class="line">[-----index:][main]下标=0----元素=a</span><br><span class="line">[-----index:][main]下标=1----元素=b</span><br><span class="line">[-----index:][main]下标=2----元素=c</span><br></pre></td></tr></table></figure>

<p>遍历一个数组/列表，只取出下标:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val array = arrayOf(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</span><br><span class="line">for (index in array.indices)&#123;</span><br><span class="line">	println(&quot;index=$index&quot;)//输出0，1，2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历取元素：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val array = arrayOf(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</span><br><span class="line">for (element in array)&#123;</span><br><span class="line">	println(&quot;element=$element&quot;)//输出a,b,c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="class"><a href="#class" class="headerlink" title=".class"></a>.class</h2><p>Service::class.java的语法展现了如何获取java.lang.Class对应的Kotlin类，这和Java中的Service.Class是完全等同的.</p>
<h2 id="java通配符-amp-kotlin声明处型变"><a href="#java通配符-amp-kotlin声明处型变" class="headerlink" title="java通配符&amp;kotlin声明处型变"></a>java通配符&amp;kotlin声明处型变</h2><h3 id="java"><a href="#java" class="headerlink" title="java"></a><strong>java</strong></h3> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public static &lt;T&gt; void copy(List&lt;? super T&gt; dest, List&lt;? extends T&gt; src) &#123;</span><br><span class="line">      // 校验略</span><br><span class="line">      ListIterator&lt;? super T&gt; di = dest.listIterator();</span><br><span class="line">      ListIterator&lt;? extends T&gt; si = src.listIterator();</span><br><span class="line">      while (si.hasNext()) &#123;</span><br><span class="line">          /**</span><br><span class="line">           * 编译时异常</span><br><span class="line">           * Incompatible types.不兼容类型；</span><br><span class="line">           * Required:T;</span><br><span class="line">           * Found:Capture&lt;? super T&gt;</span><br><span class="line">           */</span><br><span class="line">          T elementD =di.next();</span><br><span class="line"></span><br><span class="line">          T element = si.next(); //src extent 生产者 作为方法返回值类型是安全的</span><br><span class="line">          di.set(element); // dest super 消费者 作为方法参数类型是安全的</span><br><span class="line"></span><br><span class="line">          /**</span><br><span class="line">           * 编译时异常</span><br><span class="line">           * set(&lt;? extends T&gt;) in ListIterator cannot be applied.</span><br><span class="line">           * to (T)</span><br><span class="line">           */</span><br><span class="line">          si.set(elementD);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="kotlin"><a href="#kotlin" class="headerlink" title="kotlin:"></a><strong>kotlin:</strong></h3> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">abstract class Supplier&lt;out T&gt; &#123;</span><br><span class="line">       abstract fun get(): T</span><br><span class="line">       /**</span><br><span class="line">        * 编译期错误：</span><br><span class="line">        * Type parameter T is declared as &apos;out&apos; but occurs in &apos;in&apos; position in type T</span><br><span class="line">        */</span><br><span class="line">       abstract fun set(t: T)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   abstract class Customer&lt;in T&gt; &#123;</span><br><span class="line">       abstract fun set(t: T)</span><br><span class="line">       /**</span><br><span class="line">        * 编译期错误：</span><br><span class="line">        * Type parameter T is declared as &apos;in&apos; but occurs in &apos;out&apos; position in type T</span><br><span class="line">        */</span><br><span class="line">       abstract fun get(): T</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-List-lt-extends-T-gt-协变：-out"><a href="#1-List-lt-extends-T-gt-协变：-out" class="headerlink" title="1.List&lt;? extends T&gt;协变：== out"></a>1.List&lt;? extends T&gt;协变：== out</h3><p> 在si.set(elementD)中， elementD的类型是T，所以我们可以set（T t），以及一切参数中含有 T 的方法（称为消费者方法），T类型或者从T继承的类型都可以被set，但是因为可以set不同的类型，所以这些方法可能会破坏类型安全，所以编译器限制这些方法的调用。</p>
<p> 举kotlin例说明：<br> 有一方法</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fun generate(args : Array&lt;Any&gt;)&#123;</span><br><span class="line">//todo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 我们调用它：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val args : Array&lt;String&gt; = arrayOf()</span><br><span class="line">generate(args)</span><br></pre></td></tr></table></figure>

<p> 这个时候会提示异常（类型不匹配）：type mismitch，为了解决这个问题，我们只需要修改一下调用方法，使用型变out即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fun generate(args : Array&lt;out Any&gt;)&#123;</span><br><span class="line"> //todo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="List-lt-super-T-gt-逆变：-in"><a href="#List-lt-super-T-gt-逆变：-in" class="headerlink" title="List&lt;? super T&gt;逆变：== in"></a>List&lt;? super T&gt;逆变：== in</h3><p> 同协变正好相反，在T elementD =di.next();中，因为di的类型是&lt;? super T&gt;，所以我们通过di.next()获取的类型可能T,也可能是从T继承的类型，从而我们不能确定next的类型。注意，这次拒绝的理由跟协变中是不一样的。get方法并不会破坏泛型类的类型安全，主要原因在于我们不能确定get的返回类型。<br> <a href="https://www.jianshu.com/p/0c2948f7e656" target="_blank" rel="noopener">参考链接1</a><br> <a href="https://www.jianshu.com/p/ecacb7af79eb?from=timeline&isappinstalled=0" target="_blank" rel="noopener">参考链接2</a></p>
<h2 id="操作符"><a href="#操作符" class="headerlink" title="?: ?. !!操作符"></a>?: ?. !!操作符</h2><h3 id="If-not-null"><a href="#If-not-null" class="headerlink" title="?. == If not null"></a>?. == If not null</h3><p>?.就是当前面的变量!= nuil 时正常调用，如果为null就为null;并且?.可以连续使用。例如user?.userName?.length</p>
<h3 id="npe"><a href="#npe" class="headerlink" title="!!! == npe"></a>!!! == npe</h3><p>!!,加在变量名后，就是当变量为null时，抛出空指针异常;</p>
<h3 id="if-null"><a href="#if-null" class="headerlink" title="?: == if null"></a>?: == if null</h3><p>?: 仅仅在左边的表达式结果为null时才会计算 ?: 后面的表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">val map = XXXXX ?: return</span><br><span class="line">等同于</span><br><span class="line">val map = XXXXX</span><br><span class="line">if(map == null)&#123;</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line">但是if会有://Replace &apos;if&apos; with elvis operator</span><br></pre></td></tr></table></figure>

<h2 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString()"></a>toString()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Returns a string representation of the object. Can be called with a null receiver, in which case</span><br><span class="line"> * it returns the string &quot;null&quot;.</span><br><span class="line"> */</span><br><span class="line">public fun Any?.toString(): String</span><br></pre></td></tr></table></figure>

<p><strong>疑问点：</strong><br>null.toString()<br>反编译<br>String.valueOf(null)</p>
<h2 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class XXXXKT:Serializable&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>Cannot access ‘Serializable’:it is internal in ‘kotlin.io’</p>
<p>解决：import java.io.Serializable</p>
<h2 id="Suppress-“UNCHECKED-CAST”"><a href="#Suppress-“UNCHECKED-CAST”" class="headerlink" title="@Suppress(“UNCHECKED_CAST”)"></a>@Suppress(“UNCHECKED_CAST”)</h2><p>当使用 as Array<string>强转时可能会出现Unchecked cast: Any! to Array<any> 警告。解决方法就是在强转代码前加@Suppress(“UNCHECKED_CAST”)。<br>备注：@SuppressWarnings(“unchecked”)使用时机呢？</any></string></p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p><a href="https://www.jianshu.com/p/e6bbc00b18f6" target="_blank" rel="noopener">详细使用点击</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.runoob.com/kotlin/kotlin-class-object.html" target="_blank" rel="noopener">Runoob</a></p>
<p><a href="https://www.kotlincn.net/docs/reference/basic-syntax.html" target="_blank" rel="noopener">kotlincn</a></p>
<p><a href="https://handsomeliuyang.github.io/2019/05/07/Kotlin%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">Kotlin学习笔记</a></p>
]]></content>
      
        <categories>
            
            <category> Kotlin </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android </tag>
            
            <tag> Kotlin </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hexo 配置]]></title>
      <url>/2019/07/02/hello-world/</url>
      <content type="html"><![CDATA[<p>通过git+hexo搭建个人博客</p>
<a id="more"></a>
<p>More info: <a href="https://www.cnblogs.com/liuxianan/p/build-blog-website-by-hexo-github.html#%E4%BD%BF%E7%94%A8hexo%E5%86%99%E5%8D%9A%E5%AE%A2" target="_blank" rel="noopener">Deployment</a></p>
<h2 id="相关指令"><a href="#相关指令" class="headerlink" title="相关指令"></a>相关指令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo</span><br><span class="line">hexo init</span><br><span class="line">hexo g</span><br><span class="line">hexo s</span><br><span class="line">hexo d</span><br><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">hexo d</span><br><span class="line">npm install hexo --save</span><br><span class="line">hexo new &apos;kotlin使用笔记&apos;</span><br><span class="line">出现异常：使用下面命令，安装所有插件。</span><br><span class="line">npm ls --depth 0</span><br></pre></td></tr></table></figure>

<h2 id="标签抬头"><a href="#标签抬头" class="headerlink" title="标签抬头"></a>标签抬头</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 标签</span><br><span class="line">date: 2019-07-02 20:25:40</span><br><span class="line">type: tags</span><br><span class="line">layout: tags</span><br><span class="line">reward: false</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h2 id="分类抬头"><a href="#分类抬头" class="headerlink" title="分类抬头"></a>分类抬头</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 分类</span><br><span class="line">date: 2019-04-24 15:30:30</span><br><span class="line">type: categories</span><br><span class="line">layout: categories</span><br><span class="line">reward: false</span><br><span class="line">---</span><br></pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Hexo </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
